---
import SubscribeButton from "./SubscribeButton.vue";
import Button from "@/components/common/Button.astro";

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefs = await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
			user.id,
			"newsletter",
			"academy",
		);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const returnTo = Astro.url.pathname;

if (isSubscribed) {
	return null;
}
---

<div class="relative w-full rounded-xl overflow-hidden group my-8">
	<!-- Tech Border -->
	<div class="absolute inset-0 rounded-xl border border-gray-200 dark:border-gray-800 pointer-events-none z-10"></div>
	<div class="absolute inset-x-0 bottom-0 h-[2px] bg-gradient-to-r from-transparent via-primary to-transparent opacity-50"></div>
	
	<!-- Background -->
	<div class="absolute inset-0 bg-gray-50/50 dark:bg-[#080c14] backdrop-blur-sm"></div>
	<div class="absolute inset-0 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] dark:bg-[radial-gradient(#1f2937_1px,transparent_1px)] [background-size:16px_16px] opacity-50"></div>
	
	<div class="relative p-5 flex flex-col sm:flex-row items-center justify-between gap-6 z-20">
		<div class="flex items-center gap-4">
            <!-- Animated Icon -->
            <div class="hidden sm:flex relative items-center justify-center w-12 h-12 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden group-hover:border-primary/30 transition-colors duration-300">
				<div class="absolute inset-0 bg-primary/5 group-hover:bg-primary/10 transition-colors duration-300"></div>
                <div class="text-xl animate-pulse">ðŸ“¡</div>
				
				<!-- Scanline -->
				<div class="absolute top-0 w-full h-[2px] bg-primary/50 shadow-[0_0_10px_rgba(var(--brand-primary),0.5)] animate-[scan_2s_linear_infinite]"></div>
            </div>
			
			<div class="text-center sm:text-left">
				<div class="flex items-center justify-center sm:justify-start gap-2 mb-1">
					<h3 class="text-base font-bold text-gray-900 dark:text-white uppercase tracking-wider font-mono">
						System_Update
					</h3>
					<span class="relative flex h-2 w-2">
					  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
					  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
					</span>
				</div>
				<p class="text-xs md:text-sm text-gray-500 dark:text-gray-400 font-mono">
					// Subscribe for critical tech briefings and tutorials.
				</p>
			</div>
		</div>
		
		<div class="flex-shrink-0 w-full sm:w-auto">
			{user ? (
				<SubscribeButton client:visible />
			) : (
				<Button href={`/sign-in?returnTo=${encodeURIComponent(returnTo)}`} variant="primary" size="sm" class="w-full justify-center !font-mono !uppercase !tracking-wider">
					[ Connect ]
				</Button>
			)}
		</div>
	</div>
</div>

<style>
	@keyframes scan {
		0% { transform: translateY(0); opacity: 0; }
		10% { opacity: 1; }
		90% { opacity: 1; }
		100% { transform: translateY(48px); opacity: 0; }
	}
</style>
