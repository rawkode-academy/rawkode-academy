---
import SubscribeButton from "./SubscribeButton.vue";
import Button from "@/components/common/Button.vue";

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefs = await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
			user.id,
			"newsletter",
			"academy",
		);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const returnTo = Astro.url.pathname;

if (isSubscribed) {
	return null;
}
---

<div class="relative w-full max-w-5xl mx-auto my-16 group">
	<!-- Ambient Glow -->
	<div class="absolute -inset-1 bg-gradient-to-r from-primary via-secondary to-primary rounded-[2rem] blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200 animate-gradient-x"></div>
	
	<!-- Main Card -->
	<div class="relative rounded-[1.9rem] bg-white dark:bg-[#05080f] border border-black/5 dark:border-white/10 overflow-hidden isolate">
		<!-- Grid Pattern Overlay -->
		<div class="absolute inset-0 opacity-[0.03] dark:opacity-[0.07]" 
			style="background-image: radial-gradient(circle at 2px 2px, currentColor 1px, transparent 0); background-size: 24px 24px;">
		</div>

		<!-- Corner Decorations -->
		<svg class="absolute top-0 left-0 w-16 h-16 text-primary opacity-50" viewBox="0 0 64 64" fill="none">
			<path d="M2 62V2H62" stroke="currentColor" stroke-width="2" />
			<path d="M2 12L12 2" stroke="currentColor" stroke-width="2" />
		</svg>
		<svg class="absolute bottom-0 right-0 w-16 h-16 text-secondary opacity-50" viewBox="0 0 64 64" fill="none">
			<path d="M62 2V62H2" stroke="currentColor" stroke-width="2" />
			<path d="M62 52L52 62" stroke="currentColor" stroke-width="2" />
		</svg>

		<div class="relative p-8 md:p-12 flex flex-col md:flex-row items-center justify-between gap-8 md:gap-12">
			<!-- Left Content -->
			<div class="flex-1 text-center md:text-left space-y-4">
				<div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-mono font-bold tracking-wider uppercase mb-2 border border-primary/20">
					<span class="relative flex h-2 w-2">
					  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
					  <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
					</span>
					System_Broadcast_Ready
				</div>
				
				<h2 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-gray-900 via-gray-700 to-gray-900 dark:from-white dark:via-gray-200 dark:to-gray-400 tracking-tight">
					Initialize Your <br/>
					<span class="text-primary">Learning Sequence</span>
				</h2>
				
				<p class="text-gray-600 dark:text-gray-400 text-lg max-w-lg leading-relaxed">
					<span class="font-mono text-primary mr-2">></span>
					Execute subscription to receive high-priority transmission of cloud native protocols, tutorials, and system updates.
				</p>
			</div>
			
			<!-- Right Action -->
			<div class="relative w-full md:w-auto min-w-[300px]">
				<div class="absolute -inset-4 bg-gradient-to-br from-primary/20 to-secondary/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-full"></div>
				
				<div class="relative bg-white/50 dark:bg-white/5 backdrop-blur-md p-6 rounded-2xl border border-white/20 dark:border-white/10 shadow-xl">
					<div class="flex flex-col gap-4">
						<div class="flex justify-between items-center text-xs font-mono text-gray-500 dark:text-gray-400 uppercase tracking-widest pb-4 border-b border-gray-200 dark:border-gray-800/50 mb-2">
							<span>Status: Disconnected</span>
							<span class="animate-pulse text-red-400">‚óè</span>
						</div>
						
						{user ? (
							<SubscribeButton client:visible />
						) : (
							<Button href={`/sign-in?returnTo=${encodeURIComponent(returnTo)}`} variant="primary" class="w-full justify-center !font-mono !tracking-widest !uppercase !py-3">
								[ AUTHENTICATE ]
							</Button>
						)}
						
						<p class="text-[10px] text-center text-gray-400 dark:text-gray-500 font-mono">
							SECURE_CONNECTION_ENCRYPTED_256BIT
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.animate-gradient-x {
		background-size: 200% 200%;
		animation: gradient-x 3s ease infinite;
	}
	
	@keyframes gradient-x {
		0% { background-position: 0% 50% }
		50% { background-position: 100% 50% }
		100% { background-position: 0% 50% }
	}
</style>
