---
import NewsletterWidget from "./NewsletterWidget.vue";
import { createLearnerId } from "@/actions/newsletter";

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const prefs =
			await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				"academy",
			);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const pagePath = Astro.url.pathname;
const signInUrl = `/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

const { class: className } = Astro.props;

// Check for the newsletter subscription cookie (server-side)
const hasNewsletterCookie =
	Astro.cookies.get("newsletter:academy:updates")?.value === "true";

// For anonymous users with the cookie, hide the CTA entirely
const shouldHide = !user && hasNewsletterCookie;
---

{!shouldHide && (
<section class:list={["w-full", className ?? "my-12"]}>
        <div class="glass-card bg-gradient-card card-shadow p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
                        <div class="flex-1 min-w-0 space-y-1">
                                <div class="flex items-center gap-2">
                                        <span class="h-2 w-2 rounded-full bg-primary"></span>
                                        <span class="text-xs font-medium text-primary">Weekly Cloud Native insights</span>
                                </div>
                                <h2 class="text-lg sm:text-xl font-display font-semibold tracking-tight text-primary-content">
                                        Stay ahead in cloud native
                                </h2>
                                <p class="text-sm text-muted">
                                        Tutorials, deep dives, and curated eventsâ€”no fluff.
                                </p>
                        </div>

                        <div class="sm:w-64 flex-shrink-0">
                                <NewsletterWidget
                                        client:visible
                                        isSignedIn={!!user}
                                        isSubscribed={isSubscribed}
                                        signInUrl={signInUrl}
                                        pagePath={pagePath}
                                />
                        </div>
                </div>
        </div>
</section>
)}
