---
import NewsletterWidget from "./NewsletterWidget.vue";
import { createLearnerId } from "@/actions/newsletter";

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const prefs =
			await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				"academy",
			);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const pagePath = Astro.url.pathname;
const signInUrl = `/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

const { class: className } = Astro.props;

// Check for the newsletter subscription cookie (server-side)
const hasNewsletterCookie =
	Astro.cookies.get("newsletter:academy:updates")?.value === "true";

// For anonymous users with the cookie, hide the CTA entirely
const shouldHide = !user && hasNewsletterCookie;
---

{!shouldHide && (
<section class:list={["w-full max-w-5xl mx-auto px-6", className ?? "my-24"]}>
        <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-white via-white/90 to-primary/5 dark:from-neutral-900 dark:via-neutral-900 dark:to-primary/10 border border-neutral-200/80 dark:border-neutral-800 shadow-lg">
                <div class="pointer-events-none absolute inset-0 opacity-70">
                        <div class="absolute -left-12 -top-20 h-48 w-48 rounded-full bg-primary/10 blur-3xl"></div>
                        <div class="absolute -right-16 top-10 h-56 w-56 rounded-full bg-amber-400/10 blur-3xl"></div>
                </div>

                <div class="relative p-6 sm:p-8 lg:p-12 space-y-8">
                        <div class="space-y-3 text-center md:text-left max-w-3xl">
                                <span class="inline-flex items-center gap-2 rounded-full bg-primary/10 text-primary px-4 py-2 text-sm font-medium">
                                        <span class="h-2 w-2 rounded-full bg-primary"></span>
                                        Weekly Cloud Native insights
                                </span>
                                <h2 class="text-3xl sm:text-4xl font-display font-semibold tracking-tight text-neutral-900 dark:text-white">
                                        Level up your cloud skills with a newsletter that respects your time
                                </h2>

                                <p class="text-lg font-body text-neutral-700 dark:text-neutral-300 leading-relaxed">
                                        Actionable tutorials, deep dives, and curated events—no fluff. Join thousands of learners staying ahead of the curve in cloud native.
                                </p>
                        </div>

                        <div class="grid gap-8 lg:gap-12 lg:grid-cols-2 items-start">
                                <div class="space-y-5">
                                        <div class="grid gap-3 sm:grid-cols-2">
                                                <div class="flex items-start gap-3 rounded-2xl bg-white/70 dark:bg-neutral-900/60 border border-neutral-200/80 dark:border-neutral-800 p-4 shadow-sm">
                                                        <div class="mt-1 h-8 w-8 rounded-full bg-primary/10 text-primary flex items-center justify-center font-semibold">1</div>
                                                        <div class="space-y-1">
                                                                <p class="font-semibold text-neutral-900 dark:text-white">Practical guidance</p>
                                                                <p class="text-sm text-neutral-600 dark:text-neutral-400 leading-relaxed">Step-by-step walkthroughs for real-world cloud native architectures.</p>
                                                        </div>
                                                </div>
                                                <div class="flex items-start gap-3 rounded-2xl bg-white/70 dark:bg-neutral-900/60 border border-neutral-200/80 dark:border-neutral-800 p-4 shadow-sm">
                                                        <div class="mt-1 h-8 w-8 rounded-full bg-amber-400/10 text-amber-500 flex items-center justify-center font-semibold">2</div>
                                                        <div class="space-y-1">
                                                                <p class="font-semibold text-neutral-900 dark:text-white">Fresh every week</p>
                                                                <p class="text-sm text-neutral-600 dark:text-neutral-400 leading-relaxed">Stay current on tools, releases, and community events without doomscrolling.</p>
                                                        </div>
                                                </div>
                                        </div>

                                        <div class="flex items-center gap-4 flex-wrap text-sm text-neutral-600 dark:text-neutral-400">
                                                <div class="flex items-center gap-2">
                                                        <span class="h-2 w-2 rounded-full bg-green-500"></span>
                                                        Cancel anytime
                                                </div>
                                                <div class="flex items-center gap-2">
                                                        <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                                                        No spam—ever
                                                </div>
                                                <div class="flex items-center gap-2">
                                                        <span class="h-2 w-2 rounded-full bg-purple-500"></span>
                                                        Built for learners
                                                </div>
                                        </div>
                                </div>

                                <div class="w-full min-w-0 flex flex-col gap-4">
                                        <NewsletterWidget
                                                client:visible
                                                isSignedIn={!!user}
                                                isSubscribed={isSubscribed}
                                                signInUrl={signInUrl}
                                                pagePath={pagePath}
                                        />
                                        <p class="text-xs text-center text-neutral-500 dark:text-neutral-400">We only email when we have something genuinely useful to share.</p>
                                </div>
                        </div>
                </div>
        </div>
</section>
)}
