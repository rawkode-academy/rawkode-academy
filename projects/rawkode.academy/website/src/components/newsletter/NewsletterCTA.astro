---
import NewsletterWidget from "./NewsletterWidget.vue";
import { createLearnerId } from "@/actions/newsletter";

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const prefs =
			await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				"academy",
			);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const returnTo = Astro.url.pathname;
const signInUrl = `/sign-in?returnTo=${encodeURIComponent(returnTo)}`;

const { class: className } = Astro.props;

// Check for the newsletter subscription cookie (server-side)
const hasNewsletterCookie =
	Astro.cookies.get("ra_newsletter_subscribed")?.value === "true";

// For anonymous users with the cookie, hide the CTA entirely
const shouldHide = !user && hasNewsletterCookie;
---

{!shouldHide && (
<section class:list={["w-full max-w-4xl mx-auto px-6", className ?? "my-24"]}>
	<div class="relative overflow-hidden rounded-2xl bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 shadow-sm">
		
		<div class="relative p-8 md:p-12 flex flex-col md:flex-row items-center md:items-start justify-between gap-10">
			
			<div class="flex-1 text-center md:text-left space-y-4">
				<h2 class="text-3xl font-display font-semibold tracking-tight text-neutral-900 dark:text-white">
					Stay in the loop
				</h2>
				
				<p class="text-lg font-body text-neutral-600 dark:text-neutral-400 leading-relaxed max-w-md mx-auto md:mx-0">
					Get the latest cloud native tutorials, technology deep dives, and community updates delivered straight to your inbox.
				</p>
			</div>

			<div class="w-full md:w-auto min-w-[280px] flex flex-col gap-3 justify-center">
				<NewsletterWidget 
					client:visible 
					isSignedIn={!!user}
					isSubscribed={isSubscribed}
					signInUrl={signInUrl}
				/>
			</div>

		</div>
	</div>
</section>
)}
