---
export const prerender = false;

import NewsletterWidget from "./NewsletterWidget.vue";
import { createLearnerId } from "@/actions/newsletter";

interface Props {
	class?: string;
	badge?: string;
	headline?: string;
	subtitle?: string;
	audience?: string;
}

const {
	class: className,
	badge = "Weekly Cloud Native insights",
	headline = "Stay ahead in cloud native",
	subtitle = "Tutorials, deep dives, and curated eventsâ€”no fluff.",
	audience = "academy",
} = Astro.props;

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const prefs =
			await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				audience,
			);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const pagePath = Astro.url.pathname;
const signInUrl = `/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

// Check for the newsletter subscription cookie (server-side)
const hasNewsletterCookie =
	Astro.cookies.get(`newsletter:${audience}:updates`)?.value === "true";

// For anonymous users with the cookie, hide the CTA entirely
const shouldHide = !user && hasNewsletterCookie;
---

{!shouldHide && (
<section class:list={["w-full py-12 relative z-10", className]}>
        <div class="glass-card bg-gradient-card card-shadow p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
                        <div class="flex-1 min-w-0 space-y-1">
                                <div class="flex items-center gap-2">
                                        <span class="h-2 w-2 rounded-full bg-primary"></span>
                                        <span class="text-xs font-medium text-primary">{badge}</span>
                                </div>
                                <h2 class="text-lg sm:text-xl font-display font-semibold tracking-tight text-primary-content">
                                        {headline}
                                </h2>
                                <p class="text-sm text-muted">
                                        {subtitle}
                                </p>
                        </div>

                        <div class="sm:w-64 flex-shrink-0">
                                <NewsletterWidget
                                        client:visible
                                        isSignedIn={!!user}
                                        isSubscribed={isSubscribed}
                                        signInUrl={signInUrl}
                                        pagePath={pagePath}
                                        audience={audience}
                                />
                        </div>
                </div>
        </div>
</section>
)}
