---
import VideoProgressBar from "@/components/video/VideoProgressBar.vue";

interface Video {
	id: string;
	title: string;
	thumbnailUrl: string;
	duration: number;
	slug: string;
	publishedAt: string;
	streamUrl: string;
}

interface Props {
	title: string;
	description: string;
	videos?: Video[];
	watchPositions?: Record<string, number>;
	isAuthenticated?: boolean;
}

const { title, description, videos: passedVideos = [], watchPositions = {}, isAuthenticated = false } = Astro.props;

const videos: Video[] = passedVideos.map((v) => ({
	id: v.id,
	title: v.title,
	slug: v.slug,
	publishedAt: v.publishedAt,
	thumbnailUrl:
		v.thumbnailUrl ||
		`https://content.rawkode.academy/videos/${v.id}/thumbnail.jpg`,
	streamUrl:
		v.streamUrl || `https://content.rawkode.academy/videos/${v.id}/stream.m3u8`,
	duration: v.duration ?? 0,
}));

function formatDuration(seconds?: number | null) {
	if (typeof seconds !== "number" || Number.isNaN(seconds) || seconds <= 0) {
		return "--:--";
	}
	const hours = Math.floor(seconds / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	const remainingSeconds = Math.floor(seconds % 60);

	if (hours > 0) {
		return `${hours}:${minutes.toString().padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
	}
	return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
}

function formatDate(dateString: string) {
	return new Date(dateString).toLocaleDateString("en-US", {
		year: "numeric",
		month: "short",
		day: "numeric",
	});
}

function calculateProgress(videoId: string, duration: number): number | null {
	const positionSeconds = watchPositions[videoId];
	if (!positionSeconds || duration <= 0) {
		return null;
	}
	const progress = (positionSeconds / duration) * 100;
	return Math.min(progress, 100);
}
---

<section class="section-py-tight">
	<div class="text-center stack-gap-sm">
		<h2 class="text-3xl font-extrabold text-primary-content sm:text-4xl">{title}</h2>
		<p class="text-lg text-muted">{description}</p>
	</div>
	<div class="stack-gap-lg grid md:grid-cols-2 lg:grid-cols-4">
		{videos.map((video: Video) => (
			<a href={`/watch/${video.slug}`} class="group">
				<div class="relative aspect-video">
					<img
						src={video.thumbnailUrl!}
						alt={video.title}
						class="w-full h-full object-cover rounded-lg shadow-md transition-transform group-hover:scale-105"
						loading="lazy"
					/>
					{(() => {
						if (!isAuthenticated) return null;
						const progress = calculateProgress(video.id, video.duration);
						return progress !== null ? (
							<VideoProgressBar 
								progress={progress} 
								overlay={true}
								client:visible 
							/>
						) : null;
					})()}
					<div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm">
						{formatDuration(video.duration)}
					</div>
				</div>
				<div class="mt-4">
					<h3 class="text-lg font-medium text-primary-content group-hover:text-primary/90 dark:group-hover:text-primary/90 line-clamp-2">
						{video.title}
					</h3>
					<p class="mt-1 text-sm text-muted">
						{formatDate(video.publishedAt)}
					</p>
				</div>
			</a>
		))}
	</div>
</section>
