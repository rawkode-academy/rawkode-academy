---
---

<script>
	// @ts-nocheck
	const FARO_URL =
		"https://faro-collector-prod-gb-south-1.grafana.net/collect/b8e6c95e9ef352ba577b11e06a79a0e4";
	const FARO_APP_NAME = "rawkode.academy";
	const CONSENT_KEY = "consent_analytics";

	let faroInstance = null;
	let faroInitPromise = null;
	let pageStartTime = Date.now();
	let pageExitHandlerAttached = false;
	let errorHandlersAttached = false;

	const getConsent = () => {
		try {
			return localStorage.getItem(CONSENT_KEY);
		} catch {
			return null;
		}
	};

	const checkDoNotTrack = () =>
		navigator.doNotTrack === "1" || window.doNotTrack === "1";

	const isLocalhost = () =>
		window.location.hostname === "localhost" ||
		window.location.hostname === "127.0.0.1";

	const shouldEnableTracking = () =>
		getConsent() === "granted" &&
		!checkDoNotTrack() &&
		!isLocalhost() &&
		Boolean(FARO_URL);

	const getUtmParams = () => {
		try {
			const url = new URL(location.href);
			const params = new URLSearchParams(url.search);
			const keys = [
				"utm_source",
				"utm_medium",
				"utm_campaign",
				"utm_term",
				"utm_content",
			];
			const out = {};
			for (const key of keys) {
				const value = params.get(key);
				if (value) out[key] = value;
			}
			return out;
		} catch {
			return {};
		}
	};

	const createFaroConfig = (
		getWebInstrumentations,
		TracingInstrumentation,
		LogLevel,
	) => ({
		url: FARO_URL,
		app: {
			name: FARO_APP_NAME,
			version: "1.0.0",
			environment: import.meta.env.PROD ? "production" : "development",
		},
		instrumentations: [
			...getWebInstrumentations(),
			new TracingInstrumentation(),
		],
		sessionTracking: {
			enabled: true,
			persistent: true,
		},
		consoleInstrumentation: {
			disabledLevels: [LogLevel.DEBUG, LogLevel.TRACE, LogLevel.LOG, LogLevel.INFO],
		},
	});

	const trackInitialPageView = () => {
		if (!faroInstance) return;
		faroInstance.api.pushEvent("page_view", {
			path: location.pathname,
			referrer: document.referrer || "",
			title: document.title,
		});
	};

	const attachGlobalErrorHandlers = () => {
		if (errorHandlersAttached) return;
		window.addEventListener("unhandledrejection", (event) => {
			if (!faroInstance) return;
			const message = event.reason?.message || String(event.reason);
			faroInstance.api.pushError(new Error(message), {
				context: { type: "unhandledrejection" },
			});
		});

		window.addEventListener("error", (event) => {
			if (!faroInstance) return;
			const normalizedError =
				event.error instanceof Error
					? event.error
					: new Error(event.message || String(event.error || "Unknown error"));
			faroInstance.api.pushError(normalizedError, {
				context: {
					type: "global_error",
					message: event.message || "",
					filename: event.filename || "",
					lineno: String(event.lineno || 0),
				},
			});
		});
		errorHandlersAttached = true;
	};

	const attachPageExitTracking = () => {
		if (pageExitHandlerAttached) return;
		pageStartTime = Date.now();
		window.addEventListener("beforeunload", () => {
			if (!faroInstance) return;
			const seconds = Math.floor((Date.now() - pageStartTime) / 1000);
			faroInstance.api.pushEvent("page_exit", {
				path: location.pathname,
				time_on_page: String(seconds),
				referrer: document.referrer || "",
			});
		});
		pageExitHandlerAttached = true;
	};

	const initializeFaroClient = async () => {
		if (faroInstance) return faroInstance;
		if (!shouldEnableTracking()) return null;

		if (!faroInitPromise) {
			faroInitPromise = (async () => {
				const [{ initializeFaro, getWebInstrumentations, LogLevel }, { TracingInstrumentation }] =
					await Promise.all([
						import("@grafana/faro-web-sdk"),
						import("@grafana/faro-web-tracing"),
					]);

				const faro = initializeFaro(
					createFaroConfig(
						getWebInstrumentations,
						TracingInstrumentation,
						LogLevel,
					),
				);

				const utm = getUtmParams();
				faro.api.setSession({
					attributes: {
						...utm,
						viewport: `${window.innerWidth}x${window.innerHeight}`,
						language: navigator.language,
						timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
					},
				});

				faroInstance = faro;
				window.grafanaFaro = faro;
				attachGlobalErrorHandlers();
				attachPageExitTracking();
				trackInitialPageView();
				return faro;
			})().catch((error) => {
				console.warn("Failed to initialize Grafana Faro:", error);
				// Clear cached promise so future calls can retry initialization.
				faroInitPromise = null;
				return null;
			});
		}

		return faroInitPromise;
	};

	const scheduleGrafanaEnable = () => {
		if (!shouldEnableTracking()) return;

		const start = () => {
			void initializeFaroClient();
		};

		if ("requestIdleCallback" in window) {
			window.requestIdleCallback(start, { timeout: 4000 });
			return;
		}
		window.setTimeout(start, 2000);
	};

	window.grafanaFaro = null;

	// Called by consent banner after user grants consent.
	window.enableGrafanaFaro = () => {
		scheduleGrafanaEnable();
	};

	// Returning visitors with existing consent should initialize observability lazily.
	if (shouldEnableTracking()) {
		if (document.readyState === "complete") {
			scheduleGrafanaEnable();
		} else {
			window.addEventListener("load", scheduleGrafanaEnable, { once: true });
		}
	}
</script>
