---
interface Props {
	userId?: string | undefined;
}

const { userId } = Astro.props;
---

<script define:vars={{ userId }}>
	const PH_KEY = "phc_8BUP734dzskih8urQFkFL1qxT5veRDm6zzXwROZND4M";
	const PH_HOST = "https://eu.i.posthog.com";
	const CONSENT_KEY = "consent_analytics";

	let posthogInitialized = false;
	let enableInFlight = false;
	let pageExitHandlerAttached = false;
	let pageStartTime = Date.now();

	const getConsent = () => {
		try {
			return localStorage.getItem(CONSENT_KEY);
		} catch {
			return null;
		}
	};

	const checkDoNotTrack = () =>
		navigator.doNotTrack === "1" || window.doNotTrack === "1";

	const shouldEnableTracking = () =>
		getConsent() === "granted" && !checkDoNotTrack();

	const getUtmParams = () => {
		try {
			const url = new URL(location.href);
			const params = new URLSearchParams(url.search);
			const keys = [
				"utm_source",
				"utm_medium",
				"utm_campaign",
				"utm_term",
				"utm_content",
			];
			const out = {};
			for (const key of keys) {
				if (params.has(key)) {
					out[key] = params.get(key);
				}
			}
			return out;
		} catch {
			return {};
		}
	};

	const bootstrapPostHog = () => {
		!(function (t, e) {
			let o;
			let n;
			let p;
			let r;
			if (e.__SV) return;
			window.posthog = e;
			e._i = [];
			e.init = function (i, s, a) {
				function g(target, fn) {
					const parts = fn.split(".");
					if (parts.length === 2) {
						target = target[parts[0]];
						fn = parts[1];
					}
					target[fn] = function () {
						target.push(
							[fn].concat(Array.prototype.slice.call(arguments, 0)),
						);
					};
				}
				p = t.createElement("script");
				p.type = "text/javascript";
				p.crossOrigin = "anonymous";
				p.async = true;
				p.src = `${s.api_host}/static/array.js`;
				r = t.getElementsByTagName("script")[0];
				if (r?.parentNode) {
					r.parentNode.insertBefore(p, r);
				} else {
					document.head.appendChild(p);
				}
				let u = e;
				if (a !== undefined) {
					u = e[a] = [];
				} else {
					a = "posthog";
				}
				u.people = u.people || [];
				u.toString = function (noStub) {
					let d = "posthog";
					if (a !== "posthog") {
						d += `.${a}`;
					}
					if (!noStub) {
						d += " (stub)";
					}
					return d;
				};
				u.people.toString = function () {
					return `${u.toString(1)}.people (stub)`;
				};
				o =
					"capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId".split(
						" ",
					);
				for (n = 0; n < o.length; n++) {
					g(u, o[n]);
				}
				e._i.push([i, s, a]);
			};
			e.__SV = 1;
		})(document, window.posthog || []);
	};

	const enablePostHogNow = () => {
		if (posthogInitialized || enableInFlight || !shouldEnableTracking()) {
			return;
		}
		enableInFlight = true;
		bootstrapPostHog();

		window.posthog.init(PH_KEY, {
			api_host: PH_HOST,
			autocapture: true,
			capture_pageview: false,
			opt_out_capturing_by_default: false,
			respect_dnt: true,
			session_recording: {
				maskAllInputs: true,
				sampling: { rate: 0 },
			},
			loaded: function (ph) {
				try {
					ph.opt_in_capturing();
				} catch {}
			},
		});

		const utm = getUtmParams();
		if (Object.keys(utm).length > 0) {
			window.posthog.register(utm);
		}

		if (userId) {
			window.posthog.identify(userId);
		}

		window.posthog.capture("page_view", {
			path: location.pathname,
			referrer: document.referrer || "",
			title: document.title,
		});

		if (!pageExitHandlerAttached) {
			pageStartTime = Date.now();
			window.addEventListener("beforeunload", () => {
				const seconds = Math.floor((Date.now() - pageStartTime) / 1000);
				try {
					window.posthog.capture("page_exit", {
						path: location.pathname,
						time_on_page: seconds,
						referrer: document.referrer || "",
					});
				} catch {}
			});
			pageExitHandlerAttached = true;
		}

		posthogInitialized = true;
		enableInFlight = false;
	};

	const schedulePostHogEnable = () => {
		if (!shouldEnableTracking()) return;

		const start = () => enablePostHogNow();
		if ("requestIdleCallback" in window) {
			window.requestIdleCallback(start, { timeout: 3000 });
			return;
		}
		window.setTimeout(start, 1500);
	};

	// Called by consent banner after user grants consent.
	window.enablePostHog = () => {
		schedulePostHogEnable();
	};

	// Returning visitors with existing consent should initialize analytics lazily.
	if (shouldEnableTracking()) {
		if (document.readyState === "complete") {
			schedulePostHogEnable();
		} else {
			window.addEventListener("load", schedulePostHogEnable, { once: true });
		}
	}
</script>
