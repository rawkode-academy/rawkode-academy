---
import Page from "@/wrappers/page.astro";
import { captureServerEvent, getDistinctId } from "@/server/analytics";

const searchQuery = (Astro.url.searchParams.get("q") || "").trim();

interface AutoRAGResult {
	file_id: string;
	filename: string;
	score: number;
	attributes: Record<string, string | number | boolean | null>;
	content: Array<{
		type: "text";
		text: string;
	}>;
}

interface AutoRAGResponse {
	object: "vector_store.search_results.page";
	search_query: string;
	response: string;
	data: AutoRAGResult[];
	has_more: boolean;
	next_page: string | null;
}

let searchResponse: AutoRAGResponse | null = null;

if (searchQuery.length >= 2) {
	const runtime = Astro.locals.runtime;

	// Perform AutoRAG search
	searchResponse = await runtime.env.AI.autorag("polished-king-01e0").aiSearch({
		query: searchQuery,
	});

	// Track search event
	const analytics = runtime?.env?.ANALYTICS as Fetcher | undefined;
	await captureServerEvent(
		{
			event: "search_performed",
			properties: {
				query: searchQuery,
				results_count: searchResponse?.data?.length || 0,
				search_type: "autorag",
			},
			distinctId: getDistinctId(Astro),
		},
		analytics,
	);
}
---

<Page title={searchQuery ? `${searchQuery} Search Results` : "Search"}>
	<div class="max-w-4xl mx-auto px-4 py-8">
		{/* Search Input */}
		<form method="get" class="mb-8">
			<div class="relative">
				<input
					type="search"
					name="q"
					value={searchQuery}
					placeholder="Search the Rawkode Academy..."
					class="w-full px-6 py-4 pl-14 text-lg rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent shadow-sm"
				/>
				<svg
					class="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
					/>
				</svg>
			</div>
		</form>

		{searchQuery.length === 0 ? (
			<p class="text-center text-gray-500 dark:text-gray-400 py-16">
				Enter a search term to find content.
			</p>
		) : searchQuery.length < 2 ? (
			<p class="text-center text-gray-500 dark:text-gray-400 py-16">
				Please enter at least 2 characters to search.
			</p>
		) : !searchResponse || searchResponse.data.length === 0 ? (
			<p class="text-center text-gray-500 dark:text-gray-400 py-16">
				No results found for "{searchQuery}".
			</p>
		) : (
			<div class="space-y-8">
				{/* AI Summary */}
				{searchResponse.response && (
					<div class="p-6 rounded-2xl bg-gradient-to-br from-primary/10 to-secondary/10 border border-primary/20">
						<div class="flex items-center gap-2 mb-3 text-sm font-semibold text-primary uppercase tracking-wide">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
								/>
							</svg>
							<span>AI Summary</span>
						</div>
						<p class="text-gray-700 dark:text-gray-200 leading-relaxed">
							{searchResponse.response}
						</p>
					</div>
				)}

				{/* Search Results */}
				<div>
					<h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
						{searchResponse.data.length} Result{searchResponse.data.length !== 1 ? 's' : ''} Found
					</h2>
					<div class="space-y-4">
						{searchResponse.data.map((result) => {
							const contentPreview = result.content?.[0]?.text?.slice(0, 200) || "";
							const title = result.filename.replace(/\.[^/.]+$/, "").replace(/-/g, " ");
							const href = `/${result.filename.replace(/\.[^/.]+$/, "")}`;

							return (
								<a
									href={href}
									class="block p-5 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary hover:shadow-lg transition-all duration-200 group"
								>
									<h3 class="text-lg font-semibold text-gray-900 dark:text-white group-hover:text-primary transition-colors capitalize mb-2">
										{title}
									</h3>
									{contentPreview && (
										<p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed line-clamp-2">
											{contentPreview}...
										</p>
									)}
									<div class="mt-3 flex items-center gap-4 text-xs text-gray-500 dark:text-gray-500">
										<span class="flex items-center gap-1">
											<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
											</svg>
											{Math.round(result.score * 100)}% match
										</span>
										{result.attributes?.folder && (
											<span class="flex items-center gap-1">
												<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
												</svg>
												{result.attributes.folder}
											</span>
										)}
									</div>
								</a>
							);
						})}
					</div>
				</div>
			</div>
		)}
	</div>
</Page>
