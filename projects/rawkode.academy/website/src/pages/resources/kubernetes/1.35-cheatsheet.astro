---
import Page from "@/wrappers/page.astro";
import K8sCheatsheetCTA from "@/components/lead-magnet/K8sCheatsheetCTA.vue";
import { createLearnerId } from "@/actions/newsletter";

export const prerender = false;

const user = Astro.locals.user;
const pagePath = Astro.url.pathname;
const signInUrl = `/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

// Check for the cheatsheet cookie (indicates user has subscribed)
const hasCheatsheetCookie =
	Astro.cookies.get("lead-magnet:k8s-1-35-cheatsheet")?.value === "true";

// Set the cookie if user just subscribed
if (Astro.url.searchParams.has("subscribed")) {
	Astro.cookies.set("lead-magnet:k8s-1-35-cheatsheet", "true", {
		path: "/",
		maxAge: 60 * 60 * 24 * 365, // 1 year
		sameSite: "lax",
	});
}

// Check if signed-in user has subscribed to kubernetes-release-updates newsletter
let hasNewsletterSubscription = false;
if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const allPrefs = await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(prefixedUserId);
		hasNewsletterSubscription = allPrefs.some(
			(pref: { channel: string; audience: string }) =>
				pref.channel === "newsletter" && pref.audience === "kubernetes-release-updates"
		);
	} catch (e) {
		console.error("Failed to fetch email preferences", e);
	}
}

// User has access if they've subscribed (via preferences, cookie, or query param)
const hasAccess = hasNewsletterSubscription || hasCheatsheetCookie || Astro.url.searchParams.has("subscribed");

const pageTitle = "Kubernetes 1.35 Cheat Sheet | Rawkode Academy";
const pageDescription =
	"Your comprehensive guide to Kubernetes 1.35 - breaking changes, new GA features, AI/ML scheduler primitives, and migration checklist. Free for cloud native engineers.";
---

<Page title={pageTitle} description={pageDescription}>
	{hasAccess ? (
		<!-- Cheatsheet Content for Subscribed Users -->
		<section class="py-12 px-4 sm:py-16 lg:py-20">
			<div class="mx-auto max-w-4xl w-full">
				<!-- Success Header -->
				<div class="text-center mb-8 sm:mb-12">
					<div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-green-100 dark:bg-green-900/30 mb-4 sm:mb-6">
						<svg class="w-8 h-8 sm:w-10 sm:h-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
					</div>
					<h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-primary-content mb-3 sm:mb-4">
						Your Kubernetes 1.35 Cheat Sheet
					</h1>
					<p class="text-base sm:text-lg text-muted max-w-2xl mx-auto px-2">
						Thank you for joining the Rawkode Academy community. Here's everything you need to know about Kubernetes 1.35.
					</p>
				</div>

				<!-- Release Info Banner -->
				<div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-xl sm:rounded-2xl p-4 sm:p-6 mb-6 sm:mb-8 border border-blue-200 dark:border-blue-800/50">
					<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
						<div>
							<h2 class="text-base sm:text-lg font-semibold text-primary-content">Release Date: December 17, 2025</h2>
							<p class="text-xs sm:text-sm text-muted">Cycle started September 15, 2025 - Code Freeze: November 6, 2025</p>
						</div>
						<div class="flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs sm:text-sm font-medium w-fit">
							<span class="relative flex h-2 w-2">
								<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
								<span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
							</span>
							~60 Enhancements
						</div>
					</div>
				</div>

				<!-- Cheatsheet Content Card -->
				<div class="glass-panel rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 lg:p-12 mb-8 sm:mb-12">
					<h2 class="text-xl sm:text-2xl font-bold text-primary-content mb-6 sm:mb-8">
						What's New in Kubernetes 1.35
					</h2>

					<div class="space-y-8 sm:space-y-10">
						<!-- Breaking Changes -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-red-500">üö®</span> Breaking Changes (Action Required!)
							</h3>
							<div class="bg-red-50 dark:bg-red-900/20 rounded-lg sm:rounded-xl p-4 sm:p-6 border border-red-200 dark:border-red-800/50 space-y-5 sm:space-y-6">

								<!-- cgroup v1 -->
								<div>
									<h4 class="font-semibold text-primary-content mb-2 text-sm sm:text-base">cgroup v1 Support Disabled by Default</h4>
									<p class="text-muted text-xs sm:text-sm mb-3">The Kubelet config <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-xs">failCgroupV1</code> now defaults to <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-xs">true</code>. If a node boots with legacy cgroup v1 hierarchy, the Kubelet <strong>crashes immediately on startup</strong>.</p>
									<div class="bg-gray-900 rounded-lg p-3 sm:p-4 font-mono text-xs sm:text-sm overflow-x-auto space-y-1 sm:space-y-2">
										<div>
											<p class="text-gray-400"># Check if your nodes use cgroups v2</p>
											<p class="text-green-400 break-all">stat -fc %T /sys/fs/cgroup/</p>
											<p class="text-gray-400"># Returns: cgroup2fs (v2) or tmpfs (v1 - WILL FAIL!)</p>
										</div>
									</div>
								</div>

								<!-- containerd -->
								<div>
									<h4 class="font-semibold text-primary-content mb-2 text-sm sm:text-base">containerd 1.x End of Support</h4>
									<p class="text-muted text-xs sm:text-sm mb-3">Kubernetes 1.35 is the <strong>last version</strong> to support containerd 1.7. You must upgrade to containerd 2.0+ before upgrading to Kubernetes 1.36.</p>
									<div class="bg-gray-900 rounded-lg p-3 sm:p-4 font-mono text-xs sm:text-sm overflow-x-auto">
										<p class="text-gray-400"># Monitor affected nodes with this metric</p>
										<p class="text-green-400">kubelet_cri_losing_support</p>
									</div>
								</div>

								<!-- Image Pull -->
								<div>
									<h4 class="font-semibold text-primary-content mb-2 text-sm sm:text-base">Image Pull Credential Verification (Enabled by Default)</h4>
									<p class="text-muted text-xs sm:text-sm mb-3">The <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-xs">KubeletEnsureSecretPulledImages</code> feature is now enabled. Pods must have valid credentials for cached images.</p>
								</div>
							</div>
						</div>

						<!-- GA Features -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-green-500">üéì</span> Graduating to Stable (GA)
							</h3>
							<div class="bg-green-50 dark:bg-green-900/20 rounded-lg sm:rounded-xl p-4 sm:p-6 border border-green-200 dark:border-green-800/50">
								<ul class="space-y-4 text-primary-content">
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-green-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">‚úì</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">In-place Pod Resource Updates</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">Adjust CPU and memory without restarting pods! No more recreating stateful workloads for vertical scaling.</p>
											<div class="bg-gray-900 rounded-lg p-2 sm:p-3 mt-2 font-mono text-[10px] sm:text-xs overflow-x-auto">
												<p class="text-green-400 whitespace-nowrap">kubectl patch pod my-pod --subresource='resize' -p '&#123;"spec":&#123;"containers":[&#123;"name":"app","resources":&#123;"requests":&#123;"memory":"512Mi"&#125;&#125;&#125;]&#125;&#125;'</p>
											</div>
										</div>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-green-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">‚úì</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">Structured Authentication Configuration</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">Configure multiple OIDC providers via file, not flags. Hot-reload without API server restarts.</p>
										</div>
									</li>
								</ul>
							</div>
						</div>

						<!-- AI/ML Features -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-purple-500">ü§ñ</span> AI/ML & Scheduler Enhancements
							</h3>
							<div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg sm:rounded-xl p-4 sm:p-6 border border-purple-200 dark:border-purple-800/50">
								<ul class="space-y-4 text-primary-content">
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-purple-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">Œ±</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">Gang Scheduling (PodGroup)</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">Native "all-or-nothing" scheduling for distributed training. If a job needs 16 GPUs and only 10 are free, the scheduler waits for all 16.</p>
										</div>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-purple-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">Œ≤</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">DRA Binding Conditions</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">Dynamic Resource Allocation now waits for hardware initialization. GPUs and FPGAs that take seconds to configure won't cause pod failures.</p>
										</div>
									</li>
								</ul>
							</div>
						</div>

						<!-- Security -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-blue-500">üîê</span> Security
							</h3>
							<div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg sm:rounded-xl p-4 sm:p-6 border border-blue-200 dark:border-blue-800/50">
								<ul class="space-y-4 text-primary-content">
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-blue-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">Œ≤</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">User Namespaces Support</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">Run containers as UID 0 inside, but unprivileged on the host. Set <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-xs">hostUsers: false</code> in your pod spec.</p>
										</div>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<span class="text-blue-500 mt-0.5 sm:mt-1 font-bold flex-shrink-0">Œ±</span>
										<div class="min-w-0">
											<strong class="text-sm sm:text-base">Constrained Impersonation</strong>
											<p class="text-xs sm:text-sm text-muted mt-1">When impersonating another user, you can't escalate beyond your own privileges.</p>
										</div>
									</li>
								</ul>
							</div>
						</div>

						<!-- Migration Checklist -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-purple-500">‚úì</span> Migration Checklist
							</h3>
							<div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg sm:rounded-xl p-4 sm:p-6 border border-purple-200 dark:border-purple-800/50">
								<ul class="space-y-3">
									<li class="flex items-start gap-2 sm:gap-3">
										<input type="checkbox" class="w-4 h-4 sm:w-5 sm:h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mt-0.5 flex-shrink-0" />
										<span class="text-primary-content text-xs sm:text-sm"><strong>Verify cgroups v2</strong> - Run <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded text-xs break-all">stat -fc %T /sys/fs/cgroup/</code> on all nodes</span>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<input type="checkbox" class="w-4 h-4 sm:w-5 sm:h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mt-0.5 flex-shrink-0" />
										<span class="text-primary-content text-xs sm:text-sm"><strong>Check containerd version</strong> - Must be 1.7+ (2.0+ recommended)</span>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<input type="checkbox" class="w-4 h-4 sm:w-5 sm:h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mt-0.5 flex-shrink-0" />
										<span class="text-primary-content text-xs sm:text-sm"><strong>Verify image pull secrets</strong> - Pods need valid credentials for cached images</span>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<input type="checkbox" class="w-4 h-4 sm:w-5 sm:h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mt-0.5 flex-shrink-0" />
										<span class="text-primary-content text-xs sm:text-sm"><strong>Test in staging</strong> - Upgrade staging cluster first</span>
									</li>
									<li class="flex items-start gap-2 sm:gap-3">
										<input type="checkbox" class="w-4 h-4 sm:w-5 sm:h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500 mt-0.5 flex-shrink-0" />
										<span class="text-primary-content text-xs sm:text-sm"><strong>Backup etcd</strong> - Always before any upgrade</span>
									</li>
								</ul>
							</div>
						</div>

						<!-- Feature Gates -->
						<div>
							<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-3 sm:mb-4 flex items-center gap-2">
								<span class="text-gray-500">‚öôÔ∏è</span> Key Feature Gates
							</h3>
							<!-- Mobile: Card view -->
							<div class="block sm:hidden space-y-3">
								<div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
									<div class="flex items-center justify-between mb-1">
										<span class="px-2 py-0.5 rounded text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-medium">GA</span>
										<span class="text-xs text-muted">true (locked)</span>
									</div>
									<p class="font-mono text-xs text-primary-content break-all">InPlacePodVerticalScaling</p>
								</div>
								<div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
									<div class="flex items-center justify-between mb-1">
										<span class="px-2 py-0.5 rounded text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-medium">GA</span>
										<span class="text-xs text-muted">true (locked)</span>
									</div>
									<p class="font-mono text-xs text-primary-content break-all">StructuredAuthenticationConfiguration</p>
								</div>
								<div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
									<div class="flex items-center justify-between mb-1">
										<span class="px-2 py-0.5 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium">Beta</span>
										<span class="text-xs text-muted">true</span>
									</div>
									<p class="font-mono text-xs text-primary-content break-all">UserNamespacesSupport</p>
								</div>
								<div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
									<div class="flex items-center justify-between mb-1">
										<span class="px-2 py-0.5 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium">Beta</span>
										<span class="text-xs text-muted">true</span>
									</div>
									<p class="font-mono text-xs text-primary-content break-all">KubeletEnsureSecretPulledImages</p>
								</div>
							</div>
							<!-- Desktop: Table view -->
							<div class="hidden sm:block overflow-x-auto -mx-4 sm:mx-0">
								<table class="w-full text-sm min-w-[500px]">
									<thead>
										<tr class="border-b border-gray-200 dark:border-gray-700">
											<th class="text-left py-3 px-4 text-primary-content">Feature Gate</th>
											<th class="text-left py-3 px-4 text-primary-content">Stage</th>
											<th class="text-left py-3 px-4 text-primary-content">Default</th>
										</tr>
									</thead>
									<tbody class="text-muted">
										<tr class="border-b border-gray-100 dark:border-gray-800">
											<td class="py-3 px-4 font-mono text-xs">InPlacePodVerticalScaling</td>
											<td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">GA</span></td>
											<td class="py-3 px-4">true (locked)</td>
										</tr>
										<tr class="border-b border-gray-100 dark:border-gray-800">
											<td class="py-3 px-4 font-mono text-xs">StructuredAuthenticationConfiguration</td>
											<td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">GA</span></td>
											<td class="py-3 px-4">true (locked)</td>
										</tr>
										<tr class="border-b border-gray-100 dark:border-gray-800">
											<td class="py-3 px-4 font-mono text-xs">UserNamespacesSupport</td>
											<td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">Beta</span></td>
											<td class="py-3 px-4">true</td>
										</tr>
										<tr class="border-b border-gray-100 dark:border-gray-800">
											<td class="py-3 px-4 font-mono text-xs">KubeletEnsureSecretPulledImages</td>
											<td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">Beta</span></td>
											<td class="py-3 px-4">true</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- CTA -->
				<div class="text-center">
					<div class="glass-panel rounded-xl sm:rounded-2xl p-5 sm:p-8">
						<h3 class="text-lg sm:text-xl font-semibold text-primary-content mb-2">
							Continue Your Cloud Native Journey
						</h3>
						<p class="text-sm sm:text-base text-muted mb-5 sm:mb-6">
							Watch our hands-on Kubernetes tutorials and stay up-to-date with the latest cloud native content.
						</p>
						<div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
							<a
								href="/"
								class="inline-flex items-center justify-center px-5 sm:px-6 py-2.5 sm:py-3 rounded-lg sm:rounded-xl bg-primary text-white text-sm sm:text-base font-semibold hover:bg-primary/90 transition-colors"
							>
								Back to Academy
							</a>
							<a
								href="/watch"
								class="inline-flex items-center justify-center px-5 sm:px-6 py-2.5 sm:py-3 rounded-lg sm:rounded-xl border-2 border-gray-200 dark:border-gray-700 text-primary-content text-sm sm:text-base font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
							>
								Watch Kubernetes Videos
							</a>
						</div>
					</div>
				</div>
			</div>
		</section>
	) : (
		<!-- Lead Magnet CTA for Non-Subscribers -->
		<section class="py-10 px-4 sm:py-12 md:py-16 lg:py-20">
			<div class="mx-auto max-w-4xl text-center mb-8 sm:mb-12">
				<h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-primary-content mb-4 sm:mb-6 font-display px-2">
					Be Ready for <span class="text-primary">Kubernetes 1.35</span>
				</h1>
				<p class="text-base sm:text-lg md:text-xl text-secondary-content max-w-2xl mx-auto px-2">
					The biggest Kubernetes release of 2025 is coming. Don't get caught off guard by breaking changes.
				</p>
			</div>

			<div class="mx-auto max-w-7xl">
				<K8sCheatsheetCTA
					client:visible
					isSignedIn={!!user}
					isSubscribed={false}
					signInUrl={signInUrl}
					pagePath={pagePath}
				/>
			</div>

			<!-- Additional context -->
			<div class="mx-auto max-w-4xl mt-10 sm:mt-12 md:mt-16">
				<div class="glass-panel rounded-xl sm:rounded-2xl p-5 sm:p-6 md:p-8">
					<h2 class="text-lg sm:text-xl font-semibold text-primary-content mb-4">
						Why You Need This Cheat Sheet
					</h2>
					<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 text-secondary-content">
						<div>
							<h3 class="font-medium text-primary-content mb-1 sm:mb-2 text-sm sm:text-base">Breaking Changes</h3>
							<p class="text-xs sm:text-sm">
								cgroup v1 is disabled by default - kubelet will crash on older nodes. containerd 1.x support ends. Know what to fix before you upgrade.
							</p>
						</div>
						<div>
							<h3 class="font-medium text-primary-content mb-1 sm:mb-2 text-sm sm:text-base">New GA Features</h3>
							<p class="text-xs sm:text-sm">
								In-place pod scaling is finally stable. Resize CPU and memory without restarts. Structured authentication enables hot-swap OIDC.
							</p>
						</div>
						<div>
							<h3 class="font-medium text-primary-content mb-1 sm:mb-2 text-sm sm:text-base">AI/ML Scheduling</h3>
							<p class="text-xs sm:text-sm">
								Native gang scheduling for distributed training. DRA binding conditions for GPU initialization. Built for expensive hardware.
							</p>
						</div>
						<div>
							<h3 class="font-medium text-primary-content mb-1 sm:mb-2 text-sm sm:text-base">Migration Checklist</h3>
							<p class="text-xs sm:text-sm">
								Step-by-step checklist to prepare your clusters. kubectl commands to verify compatibility. Feature gate reference table.
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
	)}
</Page>
