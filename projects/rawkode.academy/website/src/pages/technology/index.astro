---
export const prerender = true;

import Page from "@/wrappers/page.astro";
import { getCollection } from "astro:content";
import { resolveTechnologyIconUrl } from "@/utils/resolve-technology-icon";

type Technology = {
	id: string;
	name: string;
	logo?: string;
	website?: string;
	documentation?: string;
};

let technologies: Technology[] = [];
try {
	const items = await getCollection("technologies");

	technologies = items.map((e) => {
		const logo = resolveTechnologyIconUrl(e.id, e.data.logos);

		const tech: Technology = {
			id: e.id,
			name: e.data.name,
			...(logo && { logo }),
			...(e.data.website && { website: e.data.website }),
			...(e.data.documentation && { documentation: e.data.documentation }),
		};
		return tech;
	});
} catch (error) {
	console.error("Failed to load technologies from content collection:", error);
}
---

<Page
	title="Technologies"
	description="Explore the various technologies covered on Rawkode Academy."
>
	<div class="flex flex-col stack-gap-lg section-py section-pt-0 page-px">
		<!-- Hero Section -->
		<section class="w-full">
			<div class="glass-panel rounded-3xl p-6 md:p-8 max-w-7xl mx-auto">
				<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
					<!-- Hero Copy -->
					<div class="flex-1 space-y-4">
						<span class="glass-chip">
							<svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
							</svg>
							Technology Hub
						</span>
						<h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white">
							Explore technologies
						</h1>
						<p class="text-gray-600 dark:text-gray-300 max-w-xl">
							Browse Rawkode Academy's catalogue of tools and platforms. Start typing to find what you're looking for.
						</p>
					</div>

					<!-- Search Controls -->
					<div class="w-full lg:w-96 space-y-3">
						<label for="technology-search" class="block text-sm font-medium text-gray-700 dark:text-gray-200">
							Search technologies
						</label>
						<div class="relative">
							<svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
							</svg>
							<input
								id="technology-search"
								type="search"
								placeholder="e.g. Grafana, Crossplane, Kubernetes..."
								class="w-full rounded-xl py-3 pl-12 pr-4 text-base text-gray-900 dark:text-white placeholder-gray-400 bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm border border-white/40 dark:border-gray-600/50 focus:outline-none focus:ring-2 focus:ring-primary/40 focus:border-primary/40 transition"
								autocomplete="off"
							/>
						</div>
						<p class="text-sm text-gray-500 dark:text-gray-400">
							Showing <span class="font-medium text-gray-700 dark:text-gray-200" data-tech-visible-count>{technologies.length}</span> of {technologies.length} technologies
						</p>
					</div>
				</div>
			</div>
		</section>

		<!-- Technologies Grid -->
		<section id="technologies" class="w-full">
			<div class="max-w-7xl mx-auto">
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
					{
						technologies.map((tech) => {
							const searchKeywords = tech.name.toLowerCase();
							
							return (
								<a
									href={`/technology/${tech.id}`}
									class="tech-card-link glass-card-shimmer card-hover flex flex-col overflow-hidden"
									data-keywords={searchKeywords}
								>
									{/* Logo Container */}
									<div class="glass-media-brand h-36 flex items-center justify-center p-6">
										<img
											src={tech.logo ?? '/apple-touch-icon.png'}
											alt={`${tech.name} Logo`}
											class="w-20 h-20 object-contain drop-shadow-lg"
											onerror={`this.onerror=null; this.src='/apple-touch-icon.png';`}
										/>
									</div>
									
									{/* Content */}
									<div class="flex-1 p-5 flex flex-col gap-3 relative z-10">
										<h3 class="text-lg font-bold text-gray-900 dark:text-white">
											{tech.name}
										</h3>
										<span class="inline-flex items-center gap-1.5 text-sm font-medium text-primary mt-auto">
											Learn more
											<svg class="w-4 h-4 transition-transform group-hover:translate-x-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
											</svg>
										</span>
									</div>
								</a>
							);
						})
					}
				</div>
				
				<!-- Empty State -->
				<div id="technology-empty-state" class="hidden">
					<div class="glass-card-shimmer rounded-2xl p-12 text-center max-w-md mx-auto">
						<svg class="w-12 h-12 mx-auto text-gray-400 dark:text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
						</svg>
						<p class="text-gray-600 dark:text-gray-400 font-medium">No technologies match your search</p>
						<p class="text-sm text-gray-500 dark:text-gray-500 mt-1">Try a different term</p>
					</div>
				</div>
			</div>
		</section>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const searchInput = document.getElementById("technology-search") as HTMLInputElement | null;
				const cards = Array.from(
					document.querySelectorAll<HTMLElement>("#technologies .tech-card-link"),
				);
				const emptyState = document.getElementById("technology-empty-state");
				const countTargets = document.querySelectorAll<HTMLElement>("[data-tech-visible-count]");

				const applySearch = () => {
					const query = (searchInput?.value ?? "").trim().toLowerCase();
					let visible = 0;

					cards.forEach((card) => {
						const keywords = card.dataset.keywords ?? "";
						const matchesSearch = keywords.includes(query);

						card.style.display = matchesSearch ? "" : "none";
						if (matchesSearch) {
							visible += 1;
						}
					});

					countTargets.forEach((el) => {
						el.textContent = visible.toString();
					});

					if (emptyState) {
						emptyState.classList.toggle("hidden", visible !== 0);
					}
				};

				searchInput?.addEventListener("input", applySearch);
				applySearch();
			});
		</script>
	</div>
</Page>
