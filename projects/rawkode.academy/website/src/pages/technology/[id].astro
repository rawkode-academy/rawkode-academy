---
export const prerender = true;

import TopicHub from "@/components/technology/TopicHub.astro";
import TechnologyCTA from "@/components/technology/TechnologyCTA.astro";
import Breadcrumb from "@/components/breadcrumb/Breadcrumb.astro";
import Page from "@/wrappers/page.astro";
import type { GetStaticPaths } from "astro";
import { getCollection, render } from "astro:content";
import matter from "gray-matter";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import { resolveContentDirSync } from "@rawkodeacademy/content";
import { resolveTechnologyIconUrl } from "@/utils/resolve-technology-icon";
import { getVideosForTechnology } from "@/utils/get-videos-for-technology";

export interface Technology {
	id: string;
	name: string;
	description: string;
	documentation?: string | undefined;
	website?: string | undefined;
	logo?: string | undefined;
	videos?:
		| {
				id: string;
				title: string;
				thumbnailUrl: string;
				slug: string;
		  }[]
		| undefined;
	radar?: {
		quadrant: "plumbing" | "platform" | "observability" | "security";
		ring: "skip" | "watch" | "explore" | "learn" | "adopt" | "advocate" | "graveyard" | "guilty-pleasure";
		confidence?: "gut" | "some-experience" | "deep-experience" | undefined;
		trajectory?: "rising" | "stable" | "falling" | undefined;
		why?: string | undefined;
		lastTouched?: string | undefined;
	} | undefined;
}

export const getStaticPaths = (async () => {
	try {
		const items = await getCollection("technologies");
		if (items.length > 0) {
			return Promise.all(
				items.map(async (e) => {
					const logo =
						resolveTechnologyIconUrl(e.id, e.data.logos) ?? undefined;
					const videos = await getVideosForTechnology(e.id);
					return {
						params: { id: e.id },
						props: {
							technology: {
								id: e.id,
								name: e.data.name,
								description: e.data.description,
								documentation: e.data.documentation,
								website: e.data.website,
								logo,
								videos,
								radar: e.data.radar,
							} as Technology,
						},
					};
				}),
			);
		}
	} catch (error) {
		console.warn(
			"getCollection('technologies') failed; falling back to FS glob:",
			error,
		);
	}

	try {
		const base = resolveContentDirSync("technologies");
		async function walk(dir: string, rel = ""): Promise<string[]> {
			const out: string[] = [];
			const entries = await readdir(dir, { withFileTypes: true });
			for (const e of entries) {
				const p = join(dir, e.name);
				const r = rel ? join(rel, e.name) : e.name;
				if (e.isDirectory()) out.push(...(await walk(p, r)));
				else if (e.isFile() && /\.mdx$/i.test(e.name)) out.push(r);
			}
			return out;
		}
		const files = await walk(base);

		return await Promise.all(
			files.map(async (rel) => {
				const id = rel.replace(/\.mdx$/i, "");
				try {
					const raw = await readFile(join(base, rel), "utf8");
					const fm = matter(raw).data as any;
					const logo = resolveTechnologyIconUrl(id, fm.logos) ?? undefined;
					const videos = await getVideosForTechnology(id);
					return {
						params: { id },
						props: {
							technology: {
								id,
								name: fm.name ?? id,
								description:
									(typeof fm.description === "string" ? fm.description : "") ??
									"",
								documentation: fm.documentation,
								website: fm.website,
								logo,
								videos,
								radar: fm.radar,
							} as Technology,
						},
					};
				} catch {
					const videos = await getVideosForTechnology(id);
					return {
						params: { id },
						props: {
							technology: {
								id,
								name: id,
								description: "",
								videos,
							} as Technology,
						},
					};
				}
			}),
		);
	} catch (error) {
		console.error("FS fallback for technologies failed:", error);
		return [];
	}
}) satisfies GetStaticPaths;

let { technology } = Astro.props as { technology?: Technology };

const id = Astro.params.id as string;
const items = await getCollection("technologies");
const technologyEntry = items.find((x) => x.id === id);
let Content: any = null;
let hasContent = false;

if (technologyEntry) {
	try {
		const rendered = await render(technologyEntry);
		Content = rendered.Content;
		hasContent = Boolean(
			technologyEntry.body && technologyEntry.body.trim().length > 0,
		);
	} catch (err) {
		console.warn("Failed to render technology content:", err);
	}
}

if (!technology) {
	try {
		const e = technologyEntry;
		if (e) {
			const logo = resolveTechnologyIconUrl(e.id, e.data.logos) ?? undefined;
			const videos = await getVideosForTechnology(e.id);
			technology = {
				id: e.id,
				name: e.data.name,
				description: e.data.description,
				documentation: e.data.documentation,
				website: e.data.website,
				logo,
				videos,
				radar: e.data.radar,
			};
		} else {
			const base = resolveContentDirSync("technologies");
			const raw = await readFile(join(base, `${id}.mdx`), "utf8");
			const fm = matter(raw).data as any;
			const logo = resolveTechnologyIconUrl(id, fm.logos) ?? undefined;
			const videos = await getVideosForTechnology(id);
			technology = {
				id,
				name: fm.name ?? id,
				description: typeof fm.description === "string" ? fm.description : "",
				documentation: fm.documentation,
				website: fm.website,
				logo,
				videos,
				radar: fm.radar,
			};
		}
	} catch (err) {
		console.error("Failed to load technology at runtime:", err);
	}
}

if (!technology) {
	return Astro.redirect("/technology");
}

const placeholderLogo = "/apple-touch-icon.png";

// Ring display helpers
const ringLabels: Record<string, string> = {
	"skip": "Skip",
	"watch": "Watch",
	"explore": "Explore",
	"learn": "Learn",
	"adopt": "Adopt",
	"advocate": "Advocate",
	"graveyard": "Graveyard",
	"guilty-pleasure": "Guilty Pleasure",
	// Legacy values
	"hold": "Skip",
	"assess": "Watch",
	"trial": "Explore",
};
const trajectoryEmoji: Record<string, string> = { rising: "↗️", stable: "→", falling: "↘️" };

const ringLabel = technology.radar?.ring ? (ringLabels[technology.radar.ring] || technology.radar.ring) : "";
const trajectoryIcon = technology.radar?.trajectory ? trajectoryEmoji[technology.radar.trajectory] : null;
---

<Page title={technology.name} description={technology.description}>
	<div class="flex flex-col stack-gap-lg section-py section-pt-0 page-px">
		<!-- Header Section -->
		<section class="w-full">
			<div class="glass-panel rounded-3xl p-6 md:p-8 max-w-7xl mx-auto">
				<!-- Breadcrumb -->
				<div class="mb-6">
					<Breadcrumb elements={[
						{ title: 'Home', link: '/' },
						{ title: 'Technologies', link: '/technology' },
						{ title: technology.name, link: `/technology/${technology.id}` },
					]} />
				</div>

				<!-- Technology Header -->
				<div class="flex flex-col md:flex-row items-center md:items-start gap-8">
					<!-- Logo -->
					<div class="glass-media-brand w-28 h-28 md:w-32 md:h-32 rounded-2xl p-4 flex items-center justify-center flex-shrink-0 shadow-lg">
						<img
							src={technology.logo ? technology.logo : placeholderLogo}
							alt={`${technology.name} Logo`}
							class="w-full h-full object-contain drop-shadow-lg"
							onerror={`this.onerror=null; this.src='${placeholderLogo}';`}
						/>
					</div>

					<!-- Info -->
					<div class="flex-1 text-center md:text-left">
						{technology.radar && (
							<a href="/technology/matrix" class="inline-flex flex-wrap items-center gap-2 mb-3 group">
								<span class={`matrix-badge matrix-badge-${technology.radar.ring}`}>
									{ringLabel}
								</span>
								<span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-primary transition-colors">
									{technology.radar.quadrant.charAt(0).toUpperCase() + technology.radar.quadrant.slice(1)}
								</span>
								{trajectoryIcon && (
									<span class="text-sm" title={`Trajectory: ${technology.radar.trajectory}`}>
										{trajectoryIcon}
									</span>
								)}
								<svg class="w-4 h-4 text-gray-400 group-hover:text-primary transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
								</svg>
							</a>
						)}
						<h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white mb-4">
							{technology.name}
						</h1>
						<p class="text-lg text-gray-600 dark:text-gray-300 mb-6 max-w-3xl">
							{technology.description}
						</p>

						<!-- Action Buttons -->
						<div class="flex flex-wrap gap-3 justify-center md:justify-start">
							{technology.website && (
								<a
									href={technology.website}
									target="_blank"
									rel="noopener noreferrer"
									class="btn-solid inline-flex items-center gap-2 px-5 py-2.5 rounded-xl"
								>
									<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
									</svg>
									Official Website
								</a>
							)}
							{technology.documentation && (
								<a
									href={technology.documentation}
									target="_blank"
									rel="noopener noreferrer"
									class="btn-glass inline-flex items-center gap-2 px-5 py-2.5 rounded-xl"
								>
									<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
									</svg>
									Documentation
								</a>
							)}
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Related Content (Videos & Articles) -->
		<section class="w-full">
			<div class="max-w-7xl mx-auto">
				<TopicHub
					technologyId={technology.id}
					technologyName={technology.name}
					videos={technology.videos || []}
				/>
			</div>
		</section>

		<!-- CTA Section -->
		<section class="w-full">
			<div class="max-w-xl mx-auto">
				<TechnologyCTA
					technologyId={technology.id}
					technologyName={technology.name}
				/>
			</div>
		</section>

		<!-- Comprehensive Guide Content -->
		{hasContent && Content && (
			<section class="w-full">
				<div class="max-w-4xl mx-auto">
					<div class="glass-panel rounded-3xl p-6 md:p-10">
						<div class="mb-8">
							<h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-2">
								Complete Guide
							</h2>
							<p class="text-gray-600 dark:text-gray-400">
								Comprehensive documentation, best practices, and getting started tutorials
							</p>
						</div>
						<article class="prose prose-lg dark:prose-invert max-w-none">
							<Content />
						</article>
					</div>
				</div>
			</section>
		)}
	</div>
</Page>

<style>
	.matrix-badge {
		display: inline-flex;
		align-items: center;
		padding: 0.25rem 0.75rem;
		border-radius: 9999px;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	/* Skip - red */
	.matrix-badge-skip,
	.matrix-badge-hold {
		background: rgba(239, 68, 68, 0.15);
		color: rgb(185, 28, 28);
		border: 1px solid rgba(239, 68, 68, 0.3);
	}

	/* Watch - orange */
	.matrix-badge-watch,
	.matrix-badge-assess {
		background: rgba(249, 115, 22, 0.15);
		color: rgb(194, 65, 12);
		border: 1px solid rgba(249, 115, 22, 0.3);
	}

	/* Explore - yellow */
	.matrix-badge-explore,
	.matrix-badge-trial {
		background: rgba(234, 179, 8, 0.15);
		color: rgb(161, 98, 7);
		border: 1px solid rgba(234, 179, 8, 0.3);
	}

	/* Learn - blue */
	.matrix-badge-learn {
		background: rgba(59, 130, 246, 0.15);
		color: rgb(29, 78, 216);
		border: 1px solid rgba(59, 130, 246, 0.3);
	}

	/* Adopt - green */
	.matrix-badge-adopt {
		background: rgba(34, 197, 94, 0.15);
		color: rgb(21, 128, 61);
		border: 1px solid rgba(34, 197, 94, 0.3);
	}

	/* Advocate - purple */
	.matrix-badge-advocate {
		background: rgba(139, 92, 246, 0.15);
		color: rgb(109, 40, 217);
		border: 1px solid rgba(139, 92, 246, 0.3);
	}

	/* Special zones */
	.matrix-badge-graveyard {
		background: rgba(107, 114, 128, 0.15);
		color: rgb(75, 85, 99);
		border: 1px solid rgba(107, 114, 128, 0.3);
	}

	.matrix-badge-guilty-pleasure {
		background: rgba(236, 72, 153, 0.15);
		color: rgb(190, 24, 93);
		border: 1px solid rgba(236, 72, 153, 0.3);
	}

	/* Dark mode adjustments */
	:global(.dark) .matrix-badge-skip,
	:global(.dark) .matrix-badge-hold {
		color: rgb(252, 165, 165);
	}

	:global(.dark) .matrix-badge-watch,
	:global(.dark) .matrix-badge-assess {
		color: rgb(253, 186, 116);
	}

	:global(.dark) .matrix-badge-explore,
	:global(.dark) .matrix-badge-trial {
		color: rgb(253, 224, 71);
	}

	:global(.dark) .matrix-badge-learn {
		color: rgb(147, 197, 253);
	}

	:global(.dark) .matrix-badge-adopt {
		color: rgb(134, 239, 172);
	}

	:global(.dark) .matrix-badge-advocate {
		color: rgb(196, 181, 253);
	}

	:global(.dark) .matrix-badge-graveyard {
		color: rgb(156, 163, 175);
	}

	:global(.dark) .matrix-badge-guilty-pleasure {
		color: rgb(249, 168, 212);
	}
</style>
