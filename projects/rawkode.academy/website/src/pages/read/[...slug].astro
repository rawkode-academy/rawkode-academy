---
import { getImage } from "astro:assets";
import { getEntry } from "astro:content";
import {
	type CollectionEntry,
	getCollection,
	getEntries,
	render,
} from "astro:content";
import RelatedArticles from "@/components/articles/RelatedArticles.astro";
import Resources from "@/components/articles/Resources.astro";
import TableOfContents from "@/components/articles/TableOfContents.astro";
import Updates from "@/components/articles/Updates.astro";
import Breadcrumb from "@/components/breadcrumb/Breadcrumb.astro";
import SeriesLink from "@/components/series/SeriesLink.astro";
import Page from "@/wrappers/page.astro";
import ArticleJsonLd from "@/components/html/article-jsonld.astro";
import InternalLinks from "@/components/seo/InternalLinks.astro";
import NewsletterCTA from "@/components/newsletter/NewsletterCTA.astro";
import type { GetStaticPaths, GetStaticPathsResult } from "astro";
import { calculateReadingTime } from "@/utils/reading-time";
import { getTypeBadgeConfig } from "@/utils/article-types";

export const prerender = true;

type Props = {
	article: CollectionEntry<"articles">;
};

const computeImageUrl = async (
	article: CollectionEntry<"articles">,
): Promise<URL | undefined> => {
	if (article.data.cover) {
		const image = await getImage({ src: article.data.cover.image });
		return new URL(image.src, Astro.site);
	}
	return undefined;
};

export const getStaticPaths: GetStaticPaths =
	async (): Promise<GetStaticPathsResult> => {
		const articles = await getCollection("articles");
		return articles.map((article: CollectionEntry<"articles">) => ({
			params: { slug: article.id },
			props: { article },
		}));
	};

const { article } = Astro.props;
const { Content, headings } = await render(article);
const authors = await getEntries(article.data.authors);
const maybeSeries =
	article.data.series && (await getEntry("series", article.data.series.id));

const imageUrl = await computeImageUrl(article);
const readingTime = calculateReadingTime(article.body || "");

const breadcrumbElements = [
	{ title: "Home", link: "/" },
	{ title: "Articles", link: "/read" },
	{ title: article.data.title, link: `/read/${article.id}` },
];

const articleType = article.data.type || "tutorial";
const badgeConfig = getTypeBadgeConfig(articleType);

const publishDate = new Intl.DateTimeFormat("en-US", {
	month: "short",
	day: "numeric",
	year: "numeric",
}).format(article.data.publishedAt);
---

<Page
	title={`${article.data.openGraph?.title || article.data.title}`}
	subtitle={article.data.openGraph?.subtitle}
	description={article.data.description}
	image={imageUrl ? {
		image: imageUrl,
		text: article.data.title,
		format: "png" as const
	} : undefined}
	useImageDirectly={true}
	isArticle={true}
	publishedAt={article.data.publishedAt}
	updatedAt={article.data.updatedAt}
	authors={authors}
>
	{imageUrl ? (
		<ArticleJsonLd slot="extra-head" article={article} authors={authors} imageUrl={imageUrl} />
	) : (
		<ArticleJsonLd slot="extra-head" article={article} authors={authors} />
	)}

	<div class="article-page">
		<!-- Breadcrumb -->
		<Breadcrumb elements={breadcrumbElements} />

		<!-- Article Header -->
		<header class="article-header">
			<!-- Title -->
			<h1>{article.data.title}</h1>

			<!-- Byline: Author + Meta in one row -->
			<div class="byline">
				<div class="byline-authors">
					{authors.map((author, i) => (
						<a
							href={`https://github.com/${author.data.handle}`}
							target="_blank"
							rel="author noopener noreferrer"
							class="author"
						>
							<img
								src={`https://avatars.githubusercontent.com/${author.data.handle}`}
								alt=""
								class="author-avatar"
								loading="lazy"
							/>
							<span class="author-name">{author.data.name}</span>
						</a>
					))}
				</div>

				<span class="byline-sep">·</span>

				<time datetime={article.data.publishedAt.toString()} class="byline-date">
					{publishDate}
				</time>

				<span class="byline-sep">·</span>

				<span class="byline-read">{readingTime.text}</span>

				<span class="byline-type">
					{badgeConfig.label}
				</span>
			</div>

			<!-- Series -->
			{maybeSeries && (
				<div class="series-link">
					<SeriesLink series={maybeSeries} />
				</div>
			)}
		</header>

		<!-- Internal Links -->
		<InternalLinks article={article} />

		<!-- Content -->
		<div class="article-content">
			<TableOfContents headings={headings} />

			<article class="prose">
				<Updates updates={article.data.updates} />
				<Content />
				<NewsletterCTA class="my-12 not-prose" />
				<Resources resources={article.data.resources} />
				<RelatedArticles currentArticle={article} limit={3} />
			</article>
		</div>
	</div>
</Page>

<style>
	.article-page {
		max-width: 100%;
	}

	/* Header - needs right padding for TOC */
	.article-header {
		margin-bottom: 2rem;
		padding-right: 4rem;
	}

	@media (max-width: 767px) {
		.article-header {
			padding-right: 0;
		}
	}

	h1 {
		font-size: clamp(1.75rem, 4.5vw, 2.5rem);
		font-weight: 800;
		line-height: 1.2;
		letter-spacing: -0.02em;
		color: rgb(17 24 39);
		margin: 0 0 1rem;
	}

	:root.dark h1 {
		color: white;
	}

	/* Byline */
	.byline {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		gap: 0.5rem 0.625rem;
		font-size: 0.875rem;
		color: rgb(107 114 128);
	}

	:root.dark .byline {
		color: rgb(156 163 175);
	}

	.byline-authors {
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.author {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		color: rgb(17 24 39);
		text-decoration: none;
		font-weight: 500;
		transition: color 0.15s;
	}

	:root.dark .author {
		color: white;
	}

	.author:hover {
		color: rgb(var(--brand-primary));
	}

	.author-avatar {
		width: 1.75rem;
		height: 1.75rem;
		border-radius: 50%;
		object-fit: cover;
	}

	.byline-sep {
		color: rgb(209 213 219);
	}

	:root.dark .byline-sep {
		color: rgb(75 85 99);
	}

	.byline-date,
	.byline-read {
		white-space: nowrap;
	}

	.byline-type {
		padding: 0.25rem 0.625rem;
		font-size: 0.6875rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: rgb(var(--brand-primary));
		background: rgb(var(--brand-primary) / 0.1);
		border-radius: 4px;
	}

	:root.dark .byline-type {
		background: rgb(var(--brand-primary) / 0.2);
	}

	/* Series */
	.series-link {
		margin-top: 1rem;
		padding-top: 1rem;
		border-top: 1px solid var(--surface-border);
	}

	/* Content */
	.article-content {
		position: relative;
	}

	.prose {
		width: 100%;
		margin-bottom: 6rem;
		padding-right: 4rem;
	}

	@media (max-width: 767px) {
		.prose {
			padding-right: 0;
		}
	}

	/* Prose overrides */
	:global(.prose pre),
	:global(.prose code),
	:global(.prose table),
	:global(.prose img),
	:global(.prose iframe) {
		max-width: 100%;
		overflow-x: auto;
	}

	:global(.prose p),
	:global(.prose li),
	:global(.prose h1),
	:global(.prose h2),
	:global(.prose h3),
	:global(.prose h4) {
		overflow-wrap: break-word;
		word-break: break-word;
	}

	:global(.prose pre) {
		white-space: pre-wrap;
	}
</style>
