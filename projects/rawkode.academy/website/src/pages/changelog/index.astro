---
import { getCollection, getEntries } from "astro:content";
import Button from "@/components/common/Button.vue";
import { Hero } from "@/components/ui";
import { marked } from "marked";
import PageWrapper from "../../wrappers/page.astro";

// Configure marked for better GitLab-style rendering
marked.setOptions({
	breaks: true,
	gfm: true,
	pedantic: false,
});

// Get all changelog entries from the articles collection
const changelogEntries = await getCollection("articles", ({ data }) => data.type === "changelog");

// Sort by date (newest first)
const sortedChangelog = changelogEntries.sort((a, b) => {
	return b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
});

// Process entries to render markdown and fetch author data
const processedChangelog = await Promise.all(
	sortedChangelog.map(async (entry) => {
		const renderedContent = marked(entry.body || "");
		const authorEntries = await getEntries(entry.data.authors);
		const firstAuthor = authorEntries[0];

		return {
			...entry.data,
			id: entry.id,
			renderedContent: String(renderedContent),
			author: {
				name: firstAuthor?.data.name || "Unknown",
				avatar_url: firstAuthor?.data.avatarUrl || "",
			},
		};
	}),
);
---

<PageWrapper
	title="Changelog"
	description="Stay up to date with the latest changes and improvements to Rawkode Academy."
>
	<!-- Hero Section -->
	<Hero
		title="Changelog"
		subtitle="Stay up to date with the latest updates, features, and improvements to Rawkode Academy."
		badge="What's New"
		background="blobs"
		pattern="grid"
		wave={true}
		stats={[
			{ label: `${changelogEntries.length} Updates` },
			{ label: 'Weekly Releases' },
			{ label: 'Open Source' }
		]}
		client:load
	>
		<Fragment slot="actions">
			<Button href="#latest" variant="primary" size="lg">View Latest</Button>
			<Button href="https://github.com/rawkode-academy" variant="ghost" size="lg">GitHub</Button>
		</Fragment>
	</Hero>

	<div id="latest" class="max-w-4xl mx-auto px-4 py-8">

		{
			processedChangelog.length === 0 ? (
				<div class="text-center py-12">
					<p class="text-gray-500 dark:text-gray-400">
						No changelog entries found.
					</p>
				</div>
			) : (
				<div class="space-y-8">
					{processedChangelog.map((entry) => (
						<article class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
							<div class="flex items-start justify-between mb-4">
								<div class="flex-1">
									<h2 class="text-xl font-semibold text-primary-content mb-2">
										{entry.title}
									</h2>
									<div
										class="text-muted mb-3 prose prose-sm dark:prose-invert max-w-none [&>p]:mb-4 [&>p:last-child]:mb-0 [&>ul]:list-disc [&>ul]:ml-6 [&>ul]:mb-4 [&>ol]:list-decimal [&>ol]:ml-6 [&>ol]:mb-4 [&>li]:mb-1"
										set:html={entry.renderedContent}
									/>
								</div>
							</div>

							<div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
								<div class="flex items-center gap-4">
									<time datetime={entry.publishedAt.toISOString()}>
										{entry.publishedAt.toLocaleDateString("en-US", {
											year: "numeric",
											month: "long",
											day: "numeric",
										})}
									</time>
									<div class="flex items-center gap-2">
										<img
											src={entry.author.avatar_url}
											alt={entry.author.name}
											class="w-5 h-5 rounded-full"
										/>
										<span>by {entry.author.name}</span>
									</div>
								</div>
							</div>
						</article>
					))}
				</div>
			)
		}
	</div>
</PageWrapper>
