---
export const prerender = false;

import { getPublishedVideos } from "@/lib/content";
import FeaturedContent from "@/components/common/FeaturedContent.astro";
import VideoMetadata from "@/components/html/video-metadata.astro";
import VideoFeed from "@/components/video/video-feed.astro";
import Page from "@/wrappers/page.astro";

const user = Astro.locals.user;

interface WatchPosition {
	videoId: string;
	positionSeconds: number;
	updatedAt: string;
}

// Set cache headers based on authentication state
if (user) {
	// Personalized content must not be publicly cached
	Astro.response.headers.set("Cache-Control", "private, no-store");
} else {
	// Public caching for unauthenticated requests (ISR)
	// Client cache: 5 minutes, Edge cache: 1 hour, Serve stale content for 24 hours during revalidation
	Astro.response.headers.set(
		"Cache-Control",
		"public, max-age=300, s-maxage=3600, stale-while-revalidate=86400",
	);
	Astro.response.headers.set("CDN-Cache-Control", "public, max-age=3600");

	// Add cache tags for targeted invalidation (only for public responses)
	Astro.response.headers.set(
		"Cache-Tag",
		"videos-page, videos-list, videos-latest",
	);
}

// Add build timestamp for debugging
Astro.response.headers.set("X-Build-Time", new Date().toISOString());

// Get page parameter from URL
const page = parseInt(Astro.url.searchParams.get("page") || "1", 10);
const videosPerPage = 16;

// Load published videos (filters out future-dated for scheduled publishing)
const allVideos = (await getPublishedVideos()).map((v) => v.data);

// Fetch watch positions for authenticated users
let watchPositionData: WatchPosition[] = [];
if (user) {
	try {
		const response = await fetch("https://api.rawkode.academy/graphql", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
				query: `
					query ContinueWatching($userId: String!, $limit: Int) {
						continueWatching(userId: $userId, limit: $limit) {
							videoId
							positionSeconds
							updatedAt
						}
					}
				`,
				variables: { userId: user.id, limit: 100 },
			}),
		});
		const json = (await response.json()) as {
			data?: { continueWatching?: WatchPosition[] };
		};
		watchPositionData = json.data?.continueWatching ?? [];
	} catch {
		// Silent failure - page still renders without watch history
	}
}

// Transform watch positions into a map
const watchPositionsMap = watchPositionData.reduce(
	(acc, item) => {
		acc[item.videoId] = item.positionSeconds;
		return acc;
	},
	{} as Record<string, number>,
);

// Featured: first item on page 1
const featuredVideo = page === 1 ? (allVideos[0] ?? null) : null;
const featuredDuration =
	featuredVideo && typeof featuredVideo.duration === "number"
		? featuredVideo.duration
		: null;

// Pagination
const start = page === 1 ? 1 : (page - 1) * videosPerPage;
const end = start + videosPerPage;
const feedVideos = allVideos.slice(start, end).map((v) => ({
	id: v.id,
	title: v.title,
	description: v.description,
	slug: v.slug,
	thumbnailUrl: `https://content.rawkode.academy/videos/${v.id}/thumbnail.jpg`,
	streamUrl: `https://content.rawkode.academy/videos/${v.id}/stream.m3u8`,
	duration: typeof v.duration === "number" ? v.duration : 0,
	publishedAt:
		v.publishedAt instanceof Date
			? v.publishedAt.toISOString()
			: String(v.publishedAt),
}));
const hasNextPage = end < allVideos.length;
---

<Page title="Videos">
	{page > 1 && (
		<Fragment slot="extra-head">
			<meta name="robots" content="noindex,follow" />
		</Fragment>
	)}
	<VideoMetadata
		slot="extra-head"
		title="Rawkode Academy Videos"
		description="Explore our collection of educational videos about cloud native technologies, development practices, and more."
		isVideoList={true}
	/>

	<!-- Featured Content Section -->
	{featuredVideo && (
		<FeaturedContent
			class="section-pt-0"
			type="video"
			title={featuredVideo.title}
			description={featuredVideo.description}
			thumbnailUrl={`https://content.rawkode.academy/videos/${featuredVideo.id}/thumbnail.jpg`}
			thumbnailAlt={`Thumbnail for ${featuredVideo.title}`}
			date={(featuredVideo.publishedAt instanceof Date ? featuredVideo.publishedAt.toISOString() : String(featuredVideo.publishedAt))}
			duration={featuredDuration !== null ? String(featuredDuration) : undefined}
			href={`/watch/${featuredVideo.slug}`}
			ctaText="Watch Now"
		/>
	)}

	<div id="latest-videos" class="flex flex-col stack-gap-lg section-py">
 		<VideoFeed
			title={page === 1 ? "Latest Videos" : `Videos - Page ${page}`}
			description={page === 1 ? "Stay up to date with our newest content" : "Browse our video collection"}
			videos={feedVideos}
			watchPositions={watchPositionsMap}
			isAuthenticated={!!user}
		/>

		{/* Pagination controls */}
		<div class="flex justify-center items-center stack-gap-sm">
			{page > 1 && (
				<a
					href={page === 2 ? "/watch" : `/watch?page=${page - 1}`}
					class="inline-block px-4 py-2 bg-gray-200 dark:bg-gray-700 text-secondary-content rounded hover:bg-gray-300 dark:hover:bg-gray-600"
				>
					← Previous
				</a>
			)}

			<span class="px-4 py-2 text-secondary-content">
				Page {page}
			</span>

			{hasNextPage && (
				<a
					href={`/watch?page=${page + 1}`}
					class="inline-block px-4 py-2 bg-primary text-white rounded hover:bg-primary/90"
				>
					Next →
				</a>
			)}
		</div>
	</div>
</Page>
