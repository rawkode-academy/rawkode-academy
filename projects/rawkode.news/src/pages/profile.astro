---
import Pagination from "@/components/common/Pagination.astro";
import PostRowSvelte from "@/components/feed/PostRowSvelte.svelte";
import AppShell from "@/components/layout/AppShell.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { buttonPrimarySmClass, buttonSecondarySmClass } from "@/lib/ui-classes";
import { listPosts, parsePageValue } from "@/lib/server/posts";
import { getSessionWithPermissions } from "@/lib/server/session";
import type { TypedEnv } from "@/types/service-bindings";

const env = Astro.locals.runtime.env as TypedEnv;
const page = parsePageValue(Astro.url.searchParams.get("page")) ?? 1;
const { session, permissions } = await getSessionWithPermissions(env, Astro.cookies);
const user = session?.user ?? null;
const profileAuthor = user?.name?.trim() || user?.email?.trim() || null;
const signInUrl = `/api/auth/sign-in?returnTo=${encodeURIComponent(
  `${Astro.url.pathname}${Astro.url.search}`,
)}`;

const submissions = profileAuthor
  ? await listPosts(env, {
      mineAuthor: profileAuthor,
      page,
      pageSize: 10,
      paginate: true,
    })
  : null;

const displayName = user?.name || user?.email || "Profile";
---

<BaseLayout
  title="Profile | Rawkode News"
  description="Your profile and submissions on Rawkode News."
  robots="noindex, nofollow"
  ogType="website"
>
  <AppShell
    pathname={Astro.url.pathname}
    search={Astro.url.search}
    user={user}
    isAdmin={Boolean(permissions?.isAdmin)}
  >
    <main class="space-y-5 py-7">
      {
        !user ? (
          <section class="space-y-3 border-y border-border/70 bg-muted/15 px-5 py-5">
            <p class="rkn-kicker">Profile</p>
            <h1 class="rkn-page-title">Sign in to view your activity</h1>
            <p class="text-sm text-muted-foreground">
              Your posts and discussion history appear here after sign-in.
            </p>
            <div>
              <a
                href={signInUrl}
                data-astro-prefetch="false"
                data-astro-reload
                class={buttonSecondarySmClass}
              >
                Sign in to continue
              </a>
            </div>
          </section>
        ) : (
          <>
            <header class="rkn-view-header flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div class="space-y-1">
                <p class="rkn-kicker">Profile</p>
                <h1 class="rkn-page-title break-words" dir="auto">{displayName}</h1>
              </div>
              <a
                href="/submit"
                class={buttonPrimarySmClass}
              >
                Create a post
              </a>
            </header>

            <section class="space-y-3">
              <header class="space-y-1">
                <h2 class="font-display text-lg font-semibold">Your posts</h2>
                <p class="text-sm text-muted-foreground">Everything you've shared with the Rawkode News community.</p>
              </header>

              <div class="overflow-hidden border-y border-border/75">
                {
                  submissions && submissions.items.length === 0 ? (
                    <p class="px-5 py-6 text-sm text-muted-foreground">You haven't published a post yet. Share your first one.</p>
                  ) : null
                }

                <div class="rkn-post-list">
                  {
                    submissions?.items.map((post, index) => (
                      <>
                        <PostRowSvelte post={post} from={`${Astro.url.pathname}${Astro.url.search}`} />
                        {index < submissions.items.length - 1 ? (
                          <hr class="rkn-post-row-separator border-border/75" />
                        ) : null}
                      </>
                    ))
                  }
                </div>
              </div>
            </section>

            {submissions ? (
              <Pagination
                page={submissions.page}
                totalPages={submissions.totalPages}
                hasMore={submissions.hasMore}
                searchParams={Astro.url.searchParams}
              />
            ) : null}
          </>
        )
      }
    </main>
  </AppShell>
</BaseLayout>
