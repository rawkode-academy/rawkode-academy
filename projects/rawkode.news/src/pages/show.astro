---
import FeedPage from "@/components/feed/FeedPage.astro";
import AppShell from "@/components/layout/AppShell.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { buildCanonicalPath } from "@/lib/seo";
import { listPosts, parsePageValue, parseTagSearchParam } from "@/lib/server/posts";
import { getSessionWithPermissions } from "@/lib/server/session";
import { listTags } from "@/lib/server/tags";
import type { TypedEnv } from "@/types/service-bindings";

const env = Astro.locals.runtime.env as TypedEnv;
const page = parsePageValue(Astro.url.searchParams.get("page")) ?? 1;
const requestedTagSlugs = parseTagSearchParam(Astro.url.searchParams.get("tags"));
const optionalTags = (await listTags(env, "optional")).sort((left, right) =>
  left.slug.localeCompare(right.slug),
);
const optionalSet = new Set(optionalTags.map((tag) => tag.slug));
const selectedTagSlugs = requestedTagSlugs.filter((slug) => optionalSet.has(slug));
const posts = await listPosts(env, {
  feed: "show",
  requestedTagSlugs: selectedTagSlugs,
  page,
  pageSize: 10,
  paginate: true,
});
const canonicalPath = buildCanonicalPath("/show", Astro.url.searchParams, ["page", "tags"]);
const { session, permissions } = await getSessionWithPermissions(env, Astro.cookies);
---

<BaseLayout
  title={page > 1 ? `Show | Rawkode News â€” Page ${page}` : "Show | Rawkode News"}
  description="Personal projects, launches, and demos shared directly by their builders."
  canonicalPath={canonicalPath}
  robots="index, follow"
  ogType="website"
>
  <AppShell
    pathname={Astro.url.pathname}
    search={Astro.url.search}
    user={session?.user ?? null}
    isAdmin={Boolean(permissions?.isAdmin)}
  >
    <FeedPage
      title="Show"
      posts={posts}
      tags={optionalTags}
      selectedTagSlugs={selectedTagSlugs}
      searchParams={Astro.url.searchParams}
      fromPath={`${Astro.url.pathname}${Astro.url.search}`}
    />
  </AppShell>
</BaseLayout>
