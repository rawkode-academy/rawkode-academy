---
import { QueryClient, dehydrate } from "@tanstack/react-query";
import App from "@/components/app";
import BaseLayout from "@/layouts/BaseLayout.astro";

const queryClient = new QueryClient();
const pageParam = Number(Astro.url.searchParams.get("page") ?? "1");
const page = Number.isFinite(pageParam) && pageParam > 0 ? pageParam : 1;
const path = Astro.url.pathname.replace(/^\/+|\/+$/g, "");
const [segment] = path.split("/");
const feedCategory = ["new", "rka", "show", "ask"].includes(segment)
	? segment
	: null;

if (feedCategory) {
	const response = await fetch(
		`${Astro.url.origin}/api/posts?category=${feedCategory}&page=${page}`
	);
	if (response.ok) {
		const data = await response.json();
		queryClient.setQueryData(["posts", feedCategory, page], data);
	}
}

const dehydratedState = dehydrate(queryClient);
---

<BaseLayout title="Rawkode News">
	<App client:only="react" dehydratedState={dehydratedState} />
</BaseLayout>
