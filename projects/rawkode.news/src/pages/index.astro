---
import { QueryClient, dehydrate } from "@tanstack/react-query";
import App from "@/components/app";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { buildCanonicalPath } from "@/lib/seo";

const queryClient = new QueryClient();
const pageParam = Number(Astro.url.searchParams.get("page") ?? "1");
const page = Number.isFinite(pageParam) && pageParam > 0 ? pageParam : 1;
const response = await fetch(
	`${Astro.url.origin}/api/posts?category=new&page=${page}`
);
if (response.ok) {
	const data = await response.json();
	queryClient.setQueryData(["posts", "new", page], data);
}
const dehydratedState = dehydrate(queryClient);
const canonicalPath = buildCanonicalPath("/", Astro.url.searchParams, ["page"]);
const title = page > 1 ? `Rawkode News â€” Page ${page}` : "Rawkode News";
---

<BaseLayout
	title={title}
	description="Latest signals from the Rawkode News community."
	canonicalPath={canonicalPath}
	robots="index, follow"
	ogType="website"
>
	<App client:only="react" dehydratedState={dehydratedState} />
</BaseLayout>
