---
import { actions } from "astro:actions";
import AppShell from "@/components/layout/AppShell.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { mandatoryTagSlugs } from "@/lib/contracts";
import {
  POST_BODY_MAX_LENGTH,
  POST_TITLE_MAX_LENGTH,
  POST_URL_MAX_LENGTH,
} from "@/lib/input-limits";
import {
  buttonPrimaryLgClass,
  buttonSecondarySmClass,
  checkboxPillSmClass,
  inputClass,
  textareaClass,
} from "@/lib/ui-classes";
import { getSessionWithPermissions } from "@/lib/server/session";
import { listTags } from "@/lib/server/tags";
import { MAX_OPTIONAL_TAGS } from "@/lib/tags";
import type { TypedEnv } from "@/types/service-bindings";

const env = Astro.locals.runtime.env as TypedEnv;
const { session, permissions } = await getSessionWithPermissions(env, Astro.cookies);
const createPostResult = Astro.getActionResult(actions.createPost);
if (createPostResult?.data?.redirectTo) {
  return Astro.redirect(createPostResult.data.redirectTo, 303);
}

const user = session?.user ?? null;
const mandatoryTagOrder = ["news", "rka", "show", "ask"] as const;
const allowedMandatoryTagSet = new Set(
  permissions?.allowedMandatoryTags ?? mandatoryTagSlugs.filter((slug) => slug !== "rka"),
);
const allowedMandatoryTags = mandatoryTagOrder.filter((slug) => allowedMandatoryTagSet.has(slug));
const defaultMandatoryTag = allowedMandatoryTags[0] ?? "news";
const optionalTags = (await listTags(env, "optional")).sort((left, right) =>
  left.slug.localeCompare(right.slug),
);

const signInUrl = `/api/auth/sign-in?returnTo=${encodeURIComponent(
  `${Astro.url.pathname}${Astro.url.search}`,
)}`;
---

<BaseLayout
  title="Submit | Rawkode News"
  description="Create a post for the Rawkode News community."
  robots="noindex, nofollow"
  ogType="website"
>
  <AppShell
    pathname={Astro.url.pathname}
    search={Astro.url.search}
    user={user}
    isAdmin={Boolean(permissions?.isAdmin)}
  >
    <main class="space-y-5 py-7">
      {
        !user ? (
          <section class="rkn-panel space-y-3 p-5">
            <h1 class="rkn-page-title">Sign in to publish a post</h1>
            <p class="text-sm text-muted-foreground">
              Share a link or write-up with enough context to evaluate quickly.
            </p>
            <div>
              <a
                href={signInUrl}
                data-astro-prefetch="false"
                data-astro-reload
                class={buttonSecondarySmClass}
              >
                Sign in to continue
              </a>
            </div>
          </section>
        ) : (
          <>
            <header class="rkn-view-header space-y-2">
              <h1 class="rkn-page-title">Create a post</h1>
              <p class="max-w-[72ch] text-sm text-muted-foreground">
                Share a link or write-up, then explain why it matters.
              </p>
            </header>

            <section class="rkn-panel overflow-hidden">
              <form id="submit-post-form" method="POST" action={actions.createPost} class="space-y-6 p-5">
                <fieldset class="space-y-6">
                  <div class="space-y-2">
                    <label for="submit-title" class="text-sm font-semibold text-foreground">
                      Title
                    </label>
                    <input
                      id="submit-title"
                      name="title"
                      required
                      maxlength={POST_TITLE_MAX_LENGTH}
                      aria-describedby="submit-title-hint"
                      dir="auto"
                      placeholder="What changed in Kubernetes scheduling?"
                      class={inputClass}
                    />
                    <p id="submit-title-hint" class="text-xs text-muted-foreground">
                      Be specific. Up to {POST_TITLE_MAX_LENGTH} characters.
                    </p>
                  </div>

                  <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground">Tags</label>
                    <div class="space-y-2">
                      <div class="grid grid-cols-4 gap-2 md:grid-cols-8">
                        <label class="relative block">
                          <span class="sr-only">Primary feed tag</span>
                          <select
                            id="submit-mandatory-tag"
                            name="mandatoryTag"
                            aria-label="Primary feed tag"
                            class="h-[var(--rkn-control-sm-height)] w-full min-w-0 cursor-pointer appearance-none rounded-md border border-input bg-card text-center text-xs font-medium text-foreground outline-none [text-align-last:center] transition-[border-color,box-shadow,background-color] duration-200 ease-[cubic-bezier(0.16,1,0.3,1)] focus-visible:border-primary/70 focus-visible:ring-[3px] focus-visible:ring-primary/20 hover:bg-muted"
                            style="padding-inline: 1.75rem"
                          >
                            {allowedMandatoryTags.map((slug) => (
                              <option value={slug} selected={slug === defaultMandatoryTag}>
                                {slug}
                              </option>
                            ))}
                          </select>
                          <span
                            aria-hidden="true"
                            class="pointer-events-none absolute top-1/2 -translate-y-1/2 text-[10px] text-foreground/70"
                            style="inset-inline-end: 0.5rem"
                          >
                            ▾
                          </span>
                        </label>

                        {
                          optionalTags.map((tag) => (
                            <label
                              class={checkboxPillSmClass}
                              title={tag.description ?? undefined}
                            >
                              <input type="checkbox" name="optionalTag" value={tag.slug} class="peer sr-only" />
                              <span class="min-w-0 truncate" dir="auto">{tag.name || tag.slug}</span>
                            </label>
                          ))
                        }
                      </div>
                      <p
                        id="submit-optional-tag-limit"
                        data-limit={MAX_OPTIONAL_TAGS}
                        aria-live="polite"
                        class="text-xs text-muted-foreground"
                      >
                        0/{MAX_OPTIONAL_TAGS} optional tags selected.
                      </p>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label for="submit-url" class="text-sm font-semibold text-foreground">
                      Source URL (optional)
                    </label>
                    <input
                      id="submit-url"
                      name="url"
                      type="url"
                      inputmode="url"
                      maxlength={POST_URL_MAX_LENGTH}
                      aria-describedby="submit-url-hint"
                      placeholder="https://..."
                      class={inputClass}
                    />
                    <p id="submit-url-hint" class="text-xs text-muted-foreground">
                      Optional. Use http:// or https://.
                    </p>
                  </div>

                  <div class="space-y-2">
                    <label for="submit-body" class="text-sm font-semibold text-foreground">Summary (Markdown, optional)</label>
                    <p id="submit-body-hint" class="text-xs text-muted-foreground">
                      Optional. Add context and tradeoffs. Up to {POST_BODY_MAX_LENGTH} characters.
                    </p>
                    <div class="grid gap-4 lg:grid-cols-2">
                      <textarea
                        id="submit-body"
                        name="body"
                        maxlength={POST_BODY_MAX_LENGTH}
                        aria-describedby="submit-body-hint"
                        dir="auto"
                        class={`${textareaClass} min-h-[290px] leading-relaxed`}
                        placeholder="What should readers know before opening this?"
                      />
                      <div
                        id="submit-body-preview"
                        class="rkn-prose rkn-prose-editor min-h-[290px] overflow-y-auto rounded-none border border-input bg-card px-3 py-2"
                      >
                        <div class="text-sm text-muted-foreground">Preview</div>
                      </div>
                    </div>
                  </div>

                  {createPostResult?.error ? <p role="alert" class="text-sm text-destructive">Could not publish post. {createPostResult.error.message}</p> : null}

                  <div>
                    <button
                      id="submit-post-button"
                      type="submit"
                      data-idle-label="Publish"
                      data-pending-label="Publishing…"
                      class={buttonPrimaryLgClass}
                    >
                      <span data-submit-label>Publish</span>
                    </button>
                  </div>
                </fieldset>
              </form>
            </section>
          </>
        )
      }
    </main>
  </AppShell>
</BaseLayout>

<script>

  const PREVIEW_DEBOUNCE_MS = 120;
  const getMarkdownRenderer = async () => {
    const module = await import("@/lib/markdown");
    return module.renderMarkdownToHtml;
  };

  const initSubmitPreview = () => {
    const textarea = document.getElementById("submit-body");
    const preview = document.getElementById("submit-body-preview");
    if (!(textarea instanceof HTMLTextAreaElement) || !(preview instanceof HTMLElement)) {
      return;
    }

    let previewTimer = 0;
    let renderToken = 0;
    let lastRenderedSource = "";

    const render = async () => {
      const token = ++renderToken;
      const source = textarea.value.trim();
      if (source === lastRenderedSource) {
        return;
      }
      lastRenderedSource = source;
      if (!source) {
        preview.innerHTML = `<div class="text-sm text-muted-foreground">Preview</div>`;
        return;
      }

      preview.innerHTML = `<div class="text-sm text-muted-foreground">Rendering preview…</div>`;
      try {
        const renderMarkdownToHtml = await getMarkdownRenderer();
        if (token !== renderToken) {
          return;
        }
        preview.innerHTML = renderMarkdownToHtml(source);
      } catch {
        if (token !== renderToken) {
          return;
        }
        preview.innerHTML = `<div class="text-sm text-destructive">Preview unavailable right now.</div>`;
      }
    };

    textarea.addEventListener("input", () => {
      window.clearTimeout(previewTimer);
      previewTimer = window.setTimeout(() => {
        void render();
      }, PREVIEW_DEBOUNCE_MS);
    });
    void render();
  };

  const initOptionalTagLimit = () => {
    const limitText = document.getElementById("submit-optional-tag-limit");
    const maxOptionalTags = Number(limitText?.getAttribute("data-limit") ?? "4");
    const optionalTagInputs = Array.from(
      document.querySelectorAll<HTMLInputElement>("input[name='optionalTag']"),
    );

    if (!(limitText instanceof HTMLElement) || optionalTagInputs.length === 0 || !Number.isFinite(maxOptionalTags)) {
      return;
    }

    const apply = () => {
      const checkedCount = optionalTagInputs.filter((input) => input.checked).length;
      const atLimit = checkedCount >= maxOptionalTags;

      optionalTagInputs.forEach((input) => {
        const shouldDisable = atLimit && !input.checked;
        input.disabled = shouldDisable;

        const label = input.closest("label");
        if (label instanceof HTMLElement) {
          label.classList.toggle("cursor-not-allowed", shouldDisable);
          label.classList.toggle("opacity-60", shouldDisable);
        }
      });

      if (atLimit) {
        limitText.textContent = `${checkedCount}/${maxOptionalTags} optional tags selected. Remove one to choose another.`;
        limitText.classList.add("text-destructive");
        limitText.classList.remove("text-muted-foreground");
      } else {
        limitText.textContent = `${checkedCount}/${maxOptionalTags} optional tags selected.`;
        limitText.classList.remove("text-destructive");
        limitText.classList.add("text-muted-foreground");
      }
    };

    optionalTagInputs.forEach((input) => input.addEventListener("change", apply));
    apply();
  };

  const initSubmitPendingState = () => {
    const form = document.getElementById("submit-post-form");
    const button = document.getElementById("submit-post-button");
    const label = document.querySelector<HTMLElement>("#submit-post-button [data-submit-label]");

    if (!(form instanceof HTMLFormElement) || !(button instanceof HTMLButtonElement) || !(label instanceof HTMLElement)) {
      return;
    }
    if (form.dataset.pendingBound === "1") {
      return;
    }

    form.dataset.pendingBound = "1";
    const idleLabel = button.getAttribute("data-idle-label") ?? "Publish";
    const pendingLabel = button.getAttribute("data-pending-label") ?? "Publishing…";
    label.textContent = idleLabel;

    form.addEventListener("submit", () => {
      if (button.disabled) {
        return;
      }
      button.disabled = true;
      button.setAttribute("aria-busy", "true");
      label.textContent = pendingLabel;
    });
  };

  const initSubmitPage = () => {
    initSubmitPreview();
    initOptionalTagLimit();
    initSubmitPendingState();
  };

  const submitEnhancementsBoundAttr = "data-rkn-submit-enhancements-bound";
  if (!document.documentElement.hasAttribute(submitEnhancementsBoundAttr)) {
    document.documentElement.setAttribute(submitEnhancementsBoundAttr, "1");
    document.addEventListener("astro:page-load", initSubmitPage);
  }
</script>
