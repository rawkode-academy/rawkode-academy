---
import type { ApiTag } from "@/lib/contracts";
import {
  tagFilterChipClass,
  tagFilterChipSelectedClass,
  tagRemovalControlClass,
  textActionMutedXsUnderlineClass,
} from "@/lib/ui-classes";

type Props = {
  tags: ApiTag[];
  selectedTagSlugs: string[];
  searchParams: URLSearchParams;
};

const { tags, selectedTagSlugs, searchParams } = Astro.props as Props;

const normalizedSelected = Array.from(
  new Set(selectedTagSlugs.map((slug) => slug.trim().toLowerCase()).filter(Boolean)),
);
const selectedSet = new Set(normalizedSelected);
const hasSelectedTags = normalizedSelected.length > 0;

const baseParams = new URLSearchParams(searchParams);
const buildHref = (next: URLSearchParams) => {
  const query = next.toString();
  return query ? `?${query}` : "?";
};

const buildSelectionHref = (slug: string, mode: "add" | "remove") => {
  const next = new URLSearchParams(baseParams);
  const selected = new Set(normalizedSelected);
  if (mode === "remove") {
    selected.delete(slug);
  } else {
    selected.add(slug);
  }

  const ordered = tags
    .map((tag) => tag.slug)
    .filter((tagSlug) => selected.has(tagSlug));

  if (ordered.length > 0) {
    next.set("tags", ordered.join(","));
  } else {
    next.delete("tags");
  }
  next.delete("page");
  next.delete("expanded");
  return buildHref(next);
};

const buildSelectHref = (slug: string) => buildSelectionHref(slug, "add");
const buildRemoveHref = (slug: string) => buildSelectionHref(slug, "remove");

const buildClearHref = () => {
  const next = new URLSearchParams(baseParams);
  next.delete("tags");
  next.delete("expanded");
  return buildHref(next);
};

---

<section class="space-y-2">
  <header class="flex items-center justify-between gap-2">
    <span class="text-xs font-semibold text-muted-foreground">Topics</span>
    {hasSelectedTags ? <a href={buildClearHref()} class={textActionMutedXsUnderlineClass}>Clear</a> : null}
  </header>

  <div class="flex flex-wrap items-center gap-2">
    {tags.map((tag) => {
      const selected = selectedSet.has(tag.slug);
      if (selected) {
        const displayName = tag.name || tag.slug;
        return (
          <span class={tagFilterChipSelectedClass} title={`Selected ${tag.slug}`}>
            <span class="min-w-0 break-all" dir="auto">{tag.name || tag.slug}</span>
            <a href={buildRemoveHref(tag.slug)} class={tagRemovalControlClass} aria-label={`Remove ${displayName}`}>
              <span aria-hidden="true">Ã—</span>
            </a>
          </span>
        );
      }

      return (
        <a
          href={buildSelectHref(tag.slug)}
          class={tagFilterChipClass}
          title={tag.description ?? undefined}
        >
          <span class="min-w-0 break-all" dir="auto">{tag.name || tag.slug}</span>
        </a>
      );
    })}
  </div>
</section>
