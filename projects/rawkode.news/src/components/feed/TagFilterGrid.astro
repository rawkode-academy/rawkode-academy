---
import type { ApiTag } from "@/lib/contracts";

type Props = {
  tags: ApiTag[];
  selectedTagSlugs: string[];
  searchParams: URLSearchParams;
};

type Cell =
  | { kind: "tag"; tag: ApiTag }
  | { kind: "show-all"; hiddenCount: number }
  | { kind: "reset" };

const { tags, selectedTagSlugs, searchParams } = Astro.props as Props;

const MOBILE_TAG_GRID_COLUMNS = 4;
const DESKTOP_TAG_GRID_COLUMNS = 8;
const RESERVED_FILTER_COLUMN_COUNT = 1;
const MOBILE_TAGS_PER_ROW = MOBILE_TAG_GRID_COLUMNS - RESERVED_FILTER_COLUMN_COUNT;
const DESKTOP_TAGS_PER_ROW = DESKTOP_TAG_GRID_COLUMNS - RESERVED_FILTER_COLUMN_COUNT;

const normalizedSelected = Array.from(
  new Set(selectedTagSlugs.map((slug) => slug.trim().toLowerCase()).filter(Boolean)),
);
const selectedSet = new Set(normalizedSelected);
const showAll = searchParams.get("expanded") === "1";

type TagLayout = {
  rows: Cell[][];
  canExpand: boolean;
};

const buildTagLayout = (tagsPerRow: number): TagLayout => {
  const tagSlotsWithoutShowAll = tagsPerRow;
  const tagSlotsWithShowAll = Math.max(1, tagsPerRow - 1);
  const canExpand = tags.length > tagSlotsWithoutShowAll;
  const collapsedVisibleTagCount = canExpand
    ? tagSlotsWithShowAll
    : tagSlotsWithoutShowAll;
  const hiddenCount = Math.max(0, tags.length - collapsedVisibleTagCount);
  const visibleTags = showAll ? tags : tags.slice(0, collapsedVisibleTagCount);
  const cells: Cell[] = [...visibleTags.map((tag) => ({ kind: "tag", tag }) as const)];

  if (canExpand && !showAll) {
    cells.push({ kind: "show-all", hiddenCount });
  }
  if (canExpand && showAll) {
    cells.push({ kind: "reset" });
  }

  const rows: Cell[][] = [];
  for (let index = 0; index < cells.length; index += tagsPerRow) {
    rows.push(cells.slice(index, index + tagsPerRow));
  }

  return {
    rows: rows.length > 0 ? rows : [[]],
    canExpand,
  };
};

const mobileTagLayout = buildTagLayout(MOBILE_TAGS_PER_ROW);
const desktopTagLayout = buildTagLayout(DESKTOP_TAGS_PER_ROW);
const canExpand = mobileTagLayout.canExpand || desktopTagLayout.canExpand;

const baseParams = new URLSearchParams(searchParams);
const buildHref = (next: URLSearchParams) => {
  const query = next.toString();
  return query ? `?${query}` : "?";
};

const buildToggleHref = (slug: string) => {
  const next = new URLSearchParams(baseParams);
  const selected = new Set(normalizedSelected);
  if (selected.has(slug)) {
    selected.delete(slug);
  } else {
    selected.add(slug);
  }

  const ordered = tags
    .map((tag) => tag.slug)
    .filter((tagSlug) => selected.has(tagSlug));

  if (ordered.length > 0) {
    next.set("tags", ordered.join(","));
  } else {
    next.delete("tags");
  }
  next.delete("page");
  if (!showAll) {
    next.delete("expanded");
  } else if (canExpand) {
    next.set("expanded", "1");
  }
  return buildHref(next);
};

const buildShowAllHref = () => {
  const next = new URLSearchParams(baseParams);
  next.set("expanded", "1");
  next.delete("page");
  return buildHref(next);
};

const buildResetHref = () => {
  const next = new URLSearchParams(baseParams);
  next.delete("tags");
  next.delete("expanded");
  next.delete("page");
  return buildHref(next);
};

const pillBaseClass =
  "inline-flex h-9 w-full min-w-0 cursor-pointer items-center justify-center gap-1 rounded-md border px-2 text-xs font-semibold disabled:cursor-not-allowed";
---

<section class="space-y-2">
  <div class="space-y-2 md:hidden">
    {mobileTagLayout.rows.map((row, rowIndex) => (
      <div class="grid grid-cols-4 gap-2">
        {rowIndex === 0 ? (
          <span
            aria-hidden="true"
            class="inline-flex h-9 w-full min-w-0 items-center justify-center px-2 text-xs font-bold uppercase tracking-wide text-foreground"
          >
            Filter
          </span>
        ) : (
          <span aria-hidden="true" class="h-9" />
        )}

        {row.map((cell) => {
          if (cell.kind === "tag") {
            const selected = selectedSet.has(cell.tag.slug);
            return (
              <a
                href={buildToggleHref(cell.tag.slug)}
                class:list={[
                  pillBaseClass,
                  selected
                    ? "border-primary/40 bg-primary/10 text-foreground"
                    : "border-border text-muted-foreground hover:bg-muted hover:text-foreground",
                ]}
                title={selected ? `Remove ${cell.tag.slug}` : cell.tag.description ?? undefined}
              >
                <span class="min-w-0 truncate">{cell.tag.name || cell.tag.slug}</span>
              </a>
            );
          }

          if (cell.kind === "show-all") {
            return (
              <a
                href={buildShowAllHref()}
                class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}
              >
                Show all ({cell.hiddenCount})
              </a>
            );
          }

          return (
            <a href={buildResetHref()} class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}>
              Reset
            </a>
          );
        })}
      </div>
    ))}
  </div>

  <div class="hidden space-y-2 md:block">
    {desktopTagLayout.rows.map((row, rowIndex) => (
      <div class="grid grid-cols-8 gap-2">
        {rowIndex === 0 ? (
          <span
            aria-hidden="true"
            class="inline-flex h-9 w-full min-w-0 items-center justify-center px-2 text-xs font-bold uppercase tracking-wide text-foreground"
          >
            Filter
          </span>
        ) : (
          <span aria-hidden="true" class="h-9" />
        )}

        {row.map((cell) => {
          if (cell.kind === "tag") {
            const selected = selectedSet.has(cell.tag.slug);
            return (
              <a
                href={buildToggleHref(cell.tag.slug)}
                class:list={[
                  pillBaseClass,
                  selected
                    ? "border-primary/40 bg-primary/10 text-foreground"
                    : "border-border text-muted-foreground hover:bg-muted hover:text-foreground",
                ]}
                title={selected ? `Remove ${cell.tag.slug}` : cell.tag.description ?? undefined}
              >
                <span class="min-w-0 truncate">{cell.tag.name || cell.tag.slug}</span>
              </a>
            );
          }

          if (cell.kind === "show-all") {
            return (
              <a
                href={buildShowAllHref()}
                class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}
              >
                Show all ({cell.hiddenCount})
              </a>
            );
          }

          return (
            <a href={buildResetHref()} class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}>
              Reset
            </a>
          );
        })}
      </div>
    ))}
  </div>
</section>
