---
import type { ApiTag } from "@/lib/contracts";

type Props = {
  tags: ApiTag[];
  selectedTagSlugs: string[];
  searchParams: URLSearchParams;
};

type Cell =
  | { kind: "tag"; tag: ApiTag }
  | { kind: "show-all"; hiddenCount: number }
  | { kind: "reset" };

const { tags, selectedTagSlugs, searchParams } = Astro.props as Props;

const TAG_GRID_COLUMNS = 8;
const TAGS_PER_ROW = TAG_GRID_COLUMNS - 1;
const TAG_SLOTS_WITHOUT_SHOW_ALL = TAGS_PER_ROW;
const TAG_SLOTS_WITH_SHOW_ALL = TAGS_PER_ROW - 1;

const normalizedSelected = Array.from(
  new Set(selectedTagSlugs.map((slug) => slug.trim().toLowerCase()).filter(Boolean)),
);
const selectedSet = new Set(normalizedSelected);
const showAll = searchParams.get("expanded") === "1";
const canExpand = tags.length > TAG_SLOTS_WITHOUT_SHOW_ALL;
const collapsedVisibleTagCount = canExpand
  ? TAG_SLOTS_WITH_SHOW_ALL
  : TAG_SLOTS_WITHOUT_SHOW_ALL;

const hiddenCount = Math.max(0, tags.length - collapsedVisibleTagCount);
const visibleTags = showAll ? tags : tags.slice(0, collapsedVisibleTagCount);

const cells: Cell[] = [
  ...visibleTags.map((tag) => ({ kind: "tag", tag }) as const),
];

if (canExpand && !showAll) {
  cells.push({ kind: "show-all", hiddenCount });
}
if (canExpand && showAll) {
  cells.push({ kind: "reset" });
}

const rows: Cell[][] = [];
for (let i = 0; i < cells.length; i += TAGS_PER_ROW) {
  rows.push(cells.slice(i, i + TAGS_PER_ROW));
}
if (rows.length === 0) {
  rows.push([]);
}

const baseParams = new URLSearchParams(searchParams);
const buildHref = (next: URLSearchParams) => {
  const query = next.toString();
  return query ? `?${query}` : "?";
};

const buildToggleHref = (slug: string) => {
  const next = new URLSearchParams(baseParams);
  const selected = new Set(normalizedSelected);
  if (selected.has(slug)) {
    selected.delete(slug);
  } else {
    selected.add(slug);
  }

  const ordered = tags
    .map((tag) => tag.slug)
    .filter((tagSlug) => selected.has(tagSlug));

  if (ordered.length > 0) {
    next.set("tags", ordered.join(","));
  } else {
    next.delete("tags");
  }
  next.delete("page");
  if (!showAll) {
    next.delete("expanded");
  } else if (canExpand) {
    next.set("expanded", "1");
  }
  return buildHref(next);
};

const buildShowAllHref = () => {
  const next = new URLSearchParams(baseParams);
  next.set("expanded", "1");
  next.delete("page");
  return buildHref(next);
};

const buildResetHref = () => {
  const next = new URLSearchParams(baseParams);
  next.delete("tags");
  next.delete("expanded");
  next.delete("page");
  return buildHref(next);
};

const pillBaseClass =
  "inline-flex h-9 w-full min-w-0 cursor-pointer items-center justify-center gap-1 rounded-md border px-2 text-xs font-semibold disabled:cursor-not-allowed";
---

<section class="space-y-2">
  {
    rows.map((row, rowIndex) => (
      <div class="grid grid-cols-8 gap-2">
        {rowIndex === 0 ? (
          <span
            aria-hidden="true"
            class="inline-flex h-9 w-full min-w-0 items-center justify-center px-2 text-xs font-bold uppercase tracking-wide text-foreground"
          >
            Filter
          </span>
        ) : (
          <span aria-hidden="true" class="h-9" />
        )}

        {row.map((cell) => {
          if (cell.kind === "tag") {
            const selected = selectedSet.has(cell.tag.slug);
            return (
              <a
                href={buildToggleHref(cell.tag.slug)}
                class:list={[
                  pillBaseClass,
                  selected
                    ? "border-primary/40 bg-primary/10 text-foreground"
                    : "border-border text-muted-foreground hover:bg-muted hover:text-foreground",
                ]}
                title={selected ? `Remove ${cell.tag.slug}` : cell.tag.description ?? undefined}
              >
                <span class="min-w-0 truncate">{cell.tag.name || cell.tag.slug}</span>
              </a>
            );
          }

          if (cell.kind === "show-all") {
            return (
              <a
                href={buildShowAllHref()}
                class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}
              >
                Show all ({cell.hiddenCount})
              </a>
            );
          }

          return (
            <a href={buildResetHref()} class:list={[pillBaseClass, "border-border bg-card text-foreground hover:bg-muted"]}>
              Reset
            </a>
          );
        })}
      </div>
    ))
  }
</section>
