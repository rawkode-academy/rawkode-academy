---
import type { StoredSession } from "@/lib/auth";
import {
  buttonPrimarySmClass,
  buttonSecondarySmClass,
  interactiveControlClass,
  menuPanelItemClass,
  shellNavItemSmClass,
  shellNavStrongItemSmClass,
} from "@/lib/ui-classes";

type Props = {
  pathname: string;
  search: string;
  user: StoredSession["user"] | null;
  isAdmin: boolean;
};

const { pathname, search, user, isAdmin } = Astro.props as Props;

const navItems = [
  { label: "New", href: "/" },
  { label: "RKA", href: "/rka" },
  { label: "News", href: "/news" },
  { label: "Show", href: "/show" },
  { label: "Ask", href: "/ask" },
  { label: "Search", href: "/search" },
];

const isActive = (href: string) =>
  href === "/" ? pathname === "/" : pathname === href;

const returnTo = `${pathname}${search}`;
const safeReturnTo = returnTo.startsWith("/") ? returnTo : "/";
const signInUrl = `/api/auth/sign-in?returnTo=${encodeURIComponent(safeReturnTo)}`;
const signOutUrl = `/api/auth/sign-out?returnTo=${encodeURIComponent(safeReturnTo)}`;
const displayName = user?.name || user?.email || "Profile";
const displayInitials = displayName
  .split(" ")
  .filter(Boolean)
  .slice(0, 2)
  .map((part) => part[0]?.toUpperCase() ?? "")
  .join("");
---

<div class="flex min-h-screen flex-col">
  <header class="rkn-shell-header rkn-no-print sticky top-0 z-50">
    <div class="rkn-container py-3.5">
      <div class="flex items-center justify-between gap-3">
        <div class="min-w-0 md:flex md:items-center md:gap-4">
          <a href="/" class="rkn-brand-link inline-flex min-w-0 shrink-0 items-center gap-3 rounded-none outline-none transition-[transform,opacity] duration-150 ease-[cubic-bezier(0.16,1,0.3,1)] focus-visible:ring-2 focus-visible:ring-ring/60">
            <div class="rkn-brand-block grid h-[var(--rkn-control-md-height)] min-w-[3.2rem] shrink-0 place-items-center rounded-none px-1">
              <span class="rkn-brand-mark" aria-hidden="true">RKN</span>
            </div>
            <div class="min-w-0">
              <p class="truncate font-display text-base leading-tight font-semibold">Rawkode News</p>
            </div>
          </a>

          <nav class="hidden items-center gap-1 rkn-nav-divider md:flex">
            {
              navItems.map((item) => (
                <a
                  href={item.href}
                  class:list={[
                    "rkn-nav-tab",
                    isActive(item.href) && "rkn-nav-tab-active",
                  ]}
                >
                  {item.label}
                </a>
              ))
            }
          </nav>
        </div>

        <div class="hidden items-center gap-2 md:flex">
          {user ? (
            <>
              <a
                href="/submit"
                class={`${buttonPrimarySmClass} min-w-[11rem]`}
              >
                Create a post
              </a>
              <details class="relative">
                <summary aria-label="Open profile menu" class={`inline-flex h-[var(--rkn-control-md-height)] min-w-[11rem] cursor-pointer list-none items-center justify-between gap-2 rounded-none border border-border bg-card px-[var(--rkn-control-inline-padding)] text-sm font-medium ${interactiveControlClass} hover:border-primary/35 hover:bg-accent [&::-webkit-details-marker]:hidden`}>
                  {user.image ? (
                    <img
                      src={user.image}
                      alt={displayName}
                      width="24"
                      height="24"
                      loading="lazy"
                      decoding="async"
                      class="h-6 w-6 rounded-none object-cover"
                    />
                  ) : (
                    <span class="grid h-6 w-6 place-items-center rounded-none bg-secondary text-[11px] font-semibold">
                      {displayInitials || "ME"}
                    </span>
                  )}
                  <span class="hidden truncate sm:inline" dir="auto">{displayName}</span>
                  <span class="text-[10px] text-muted-foreground">▾</span>
                </summary>
                <div
                  class="absolute mt-2 w-72 max-w-[92vw] overflow-hidden rounded-none border border-border bg-card"
                  style="inset-inline-end: 0"
                >
                  <div class="border-b border-border px-4 py-3">
                    <p class="text-sm font-semibold text-foreground" dir="auto">{displayName}</p>
                    {user.email ? <p class="break-all text-xs text-muted-foreground">{user.email}</p> : null}
                  </div>
                  <div class="p-1.5 text-sm">
                    <a href="/profile" class={menuPanelItemClass}>
                      Profile
                    </a>
                    {isAdmin ? (
                      <a href="/admin/tags" class={menuPanelItemClass}>
                        Admin tags
                      </a>
                    ) : null}
                    <a
                      href={signOutUrl}
                      data-astro-prefetch="false"
                      data-astro-reload
                      class={menuPanelItemClass}
                    >
                      Sign out
                    </a>
                  </div>
                </div>
              </details>
            </>
          ) : (
            <a
              href={signInUrl}
              data-astro-prefetch="false"
              data-astro-reload
              class={buttonSecondarySmClass}
            >
              Sign in
            </a>
          )}
        </div>

        <details class="relative md:hidden">
          <summary aria-label="Open navigation menu" class={`grid size-[var(--rkn-control-md-height)] cursor-pointer list-none place-items-center rounded-none border border-border bg-card text-muted-foreground ${interactiveControlClass} hover:bg-accent [&::-webkit-details-marker]:hidden`}>
            <span class="text-xs">☰</span>
          </summary>
          <div
            class="absolute mt-2 w-[min(22rem,90vw)] rounded-none border border-border bg-card"
            style="inset-inline-end: 0"
          >
            <div class="rkn-container space-y-2 py-3">
              <div class="grid gap-1.5">
                {
                  navItems.map((item) => (
                    <a
                      href={item.href}
                      class:list={[
                        shellNavStrongItemSmClass,
                        isActive(item.href)
                          ? "rkn-nav-tab-active"
                          : "text-muted-foreground hover:bg-accent hover:text-foreground",
                      ]}
                    >
                      {item.label}
                    </a>
                  ))
                }
              </div>

              {user ? (
                <div class="grid gap-2 border-t border-border pt-2">
                  <a
                    href="/submit"
                    class={buttonPrimarySmClass}
                  >
                    Create a post
                  </a>
                  <a href="/profile" class={shellNavItemSmClass}>
                    Profile
                  </a>
                  {isAdmin ? (
                    <a href="/admin/tags" class={shellNavItemSmClass}>
                      Admin tags
                    </a>
                  ) : null}
                  <a
                    href={signOutUrl}
                    data-astro-prefetch="false"
                    data-astro-reload
                    class={buttonSecondarySmClass}
                  >
                    Sign out
                  </a>
                </div>
              ) : (
                <div class="border-t border-border pt-2">
                  <a
                    href={signInUrl}
                    data-astro-prefetch="false"
                    data-astro-reload
                    class={`${buttonSecondarySmClass} w-full`}
                  >
                    Sign in
                  </a>
                </div>
              )}
            </div>
          </div>
        </details>
      </div>
    </div>
  </header>

  <div class="flex flex-1 flex-col">
    <div class="rkn-container flex flex-1 flex-col">
      <slot />
    </div>
  </div>

  <footer class="rkn-no-print border-t border-border/80 bg-background/85">
    <div class="rkn-container flex flex-wrap items-center gap-2 py-5 text-xs text-muted-foreground">
      <span>
        powered by{" "}
        <a href="https://rawkode.academy" class="font-medium text-foreground/80 outline-none transition-colors duration-150 ease-[cubic-bezier(0.16,1,0.3,1)] hover:text-foreground focus-visible:ring-2 focus-visible:ring-ring/60">
          Rawkode Academy
        </a>
      </span>
      <span aria-hidden="true">•</span>
      <a href="/rss.xml" class="text-[11px] font-bold uppercase tracking-wide outline-none transition-colors duration-150 ease-[cubic-bezier(0.16,1,0.3,1)] hover:text-foreground focus-visible:ring-2 focus-visible:ring-ring/60">
        RSS
      </a>
    </div>
  </footer>
</div>
