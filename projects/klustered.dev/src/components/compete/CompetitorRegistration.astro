---
export const prerender = false;

import RegisterButton from "./RegisterButton.vue";
import { createLearnerId } from "@/actions/newsletter";
import { css } from "styled-system/css";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;

const user = Astro.locals.user;
let isSoloRegistered = false;
let isTeamRegistered = false;

if (user) {
	try {
		const env = Astro.locals.runtime.env;
		const prefixedUserId = createLearnerId(user.id);
		const [soloPrefs, teamPrefs] = await Promise.all([
			env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				"klustered-solo",
			),
			env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				"klustered-team",
			),
		]);
		isSoloRegistered = soloPrefs.length > 0;
		isTeamRegistered = teamPrefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch competitor status", e);
	}
}

const isRegistered = isSoloRegistered || isTeamRegistered;

const pagePath = Astro.url.pathname;
const signInUrl = `/api/auth/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

const containerStyles = css({
	width: "100%",
	padding: "2rem 0",
	position: "relative",
	zIndex: 10,
});

const cardStyles = css({
	background: "linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.05))",
	backdropFilter: "blur(10px)",
	borderRadius: "1rem",
	border: "1px solid rgba(139, 92, 246, 0.2)",
	padding: "2rem",
	textAlign: "center",
});

const headlineStyles = css({
	fontSize: "1.5rem",
	fontWeight: 700,
	color: "white",
	marginBottom: "0.5rem",
	"@media (min-width: 640px)": {
		fontSize: "1.75rem",
	},
});

const subtitleStyles = css({
	fontSize: "1rem",
	color: "rgba(255, 255, 255, 0.7)",
	marginBottom: "1.5rem",
});

const buttonContainerStyles = css({
	display: "flex",
	justifyContent: "center",
});
---

<section class:list={[containerStyles, className]}>
	<div class={cardStyles}>
		<h2 class={headlineStyles}>
			{isRegistered ? "Your Application" : "Ready to Apply?"}
		</h2>
		<p class={subtitleStyles}>
			{isRegistered
				? "Manage your application for Klustered '26."
				: "Choose how you want to compete in Klustered '26."
			}
		</p>
		<div class={buttonContainerStyles}>
			<RegisterButton
				client:visible
				isSignedIn={!!user}
				isSoloRegistered={isSoloRegistered}
				isTeamRegistered={isTeamRegistered}
				signInUrl={signInUrl}
				pagePath={pagePath}
			/>
		</div>
	</div>
</section>
