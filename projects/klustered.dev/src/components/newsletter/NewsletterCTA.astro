---
export const prerender = false;

import NewsletterWidget from "./NewsletterWidget.vue";
import { createLearnerId } from "@/actions/newsletter";
import { css } from "styled-system/css";

interface Props {
	class?: string;
	badge?: string;
	headline?: string;
	subtitle?: string;
	audience?: string;
}

const {
	class: className,
	badge = "Klustered Updates",
	headline = "Stay in the loop",
	subtitle = "Get notified about upcoming challenges and results.",
	audience = "klustered-watch",
} = Astro.props;

const user = Astro.locals.user;
let isSubscribed = false;

if (user) {
	try {
		const prefixedUserId = createLearnerId(user.id);
		const prefs =
			await Astro.locals.runtime.env.EMAIL_PREFERENCES.getPreferences(
				prefixedUserId,
				"newsletter",
				audience,
			);
		isSubscribed = prefs.length > 0;
	} catch (e) {
		console.error("Failed to fetch preferences", e);
	}
}

const pagePath = Astro.url.pathname;
const signInUrl = `/api/auth/sign-in?returnTo=${encodeURIComponent(pagePath)}`;

// Check for the newsletter subscription cookie (server-side)
const hasNewsletterCookie =
	Astro.cookies.get(`newsletter:${audience}:updates`)?.value === "true";

// For anonymous users with the cookie, hide the CTA entirely
const shouldHide = !user && hasNewsletterCookie;

const containerStyles = css({
	width: "100%",
	padding: "2rem 0",
	position: "relative",
	zIndex: 10,
});

const cardStyles = css({
	background: "rgba(255, 255, 255, 0.05)",
	backdropFilter: "blur(10px)",
	borderRadius: "1rem",
	border: "1px solid rgba(255, 255, 255, 0.1)",
	padding: "1.5rem",
});

const contentStyles = css({
	display: "flex",
	flexDirection: "column",
	gap: "1rem",
	"@media (min-width: 640px)": {
		flexDirection: "row",
		alignItems: "center",
		gap: "1.5rem",
	},
});

const textContainerStyles = css({
	flex: 1,
	minWidth: 0,
	display: "flex",
	flexDirection: "column",
	gap: "0.25rem",
});

const badgeContainerStyles = css({
	display: "flex",
	alignItems: "center",
	gap: "0.5rem",
});

const badgeDotStyles = css({
	height: "0.5rem",
	width: "0.5rem",
	borderRadius: "9999px",
	background: "linear-gradient(135deg, #8b5cf6, #a855f7)",
});

const badgeTextStyles = css({
	fontSize: "0.75rem",
	fontWeight: 500,
	color: "#a855f7",
});

const headlineStyles = css({
	fontSize: "1.125rem",
	fontWeight: 600,
	color: "white",
	"@media (min-width: 640px)": {
		fontSize: "1.25rem",
	},
});

const subtitleStyles = css({
	fontSize: "0.875rem",
	color: "rgba(255, 255, 255, 0.6)",
});

const widgetContainerStyles = css({
	flexShrink: 0,
	"@media (min-width: 640px)": {
		width: "16rem",
	},
});
---

{!shouldHide && (
<section class:list={[containerStyles, className]}>
	<div class={cardStyles}>
		<div class={contentStyles}>
			<div class={textContainerStyles}>
				<div class={badgeContainerStyles}>
					<span class={badgeDotStyles}></span>
					<span class={badgeTextStyles}>{badge}</span>
				</div>
				<h2 class={headlineStyles}>
					{headline}
				</h2>
				<p class={subtitleStyles}>
					{subtitle}
				</p>
			</div>

			<div class={widgetContainerStyles}>
				<NewsletterWidget
					client:visible
					isSignedIn={!!user}
					isSubscribed={isSubscribed}
					signInUrl={signInUrl}
					pagePath={pagePath}
					audience={audience}
				/>
			</div>
		</div>
	</div>
</section>
)}
