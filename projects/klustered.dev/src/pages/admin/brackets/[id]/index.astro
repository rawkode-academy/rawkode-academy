---
export const prerender = false;

import { css } from "styled-system/css";
import "../../../../styles/global.css";
import { actions } from "astro:actions";
import BracketForm from "@/components/bracket/admin/BracketForm.vue";

const user = Astro.locals.user;

const ADMIN_USER_IDS = ["rawkode"];
const isAdmin = user && ADMIN_USER_IDS.includes(user.id);

if (!user) {
	return Astro.redirect(`/api/auth/sign-in?returnTo=${encodeURIComponent(Astro.url.pathname)}`);
}

if (!isAdmin) {
	return Astro.redirect("/");
}

const { id } = Astro.params;

if (!id) {
	return Astro.redirect("/admin");
}

const { data, error } = await Astro.callAction(actions.bracket.getBracketById, { id });

if (error || !data) {
	return Astro.redirect("/admin");
}

const { bracket, competitors, matches } = data;

const confirmedCount = competitors.filter((c) => c.confirmed).length;
const totalCount = competitors.length;

const pageStyles = css({
	minHeight: "100vh",
	background: "linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%)",
	paddingBlock: "2rem",
	paddingInline: "1rem",
});

const containerStyles = css({
	maxWidth: "1000px",
	marginInline: "auto",
});

const backLinkStyles = css({
	display: "inline-flex",
	alignItems: "center",
	gap: "0.5rem",
	color: "rgba(255, 255, 255, 0.6)",
	textDecoration: "none",
	fontSize: "0.875rem",
	marginBottom: "1.5rem",
	transition: "color 0.2s",
	"&:hover": {
		color: "white",
	},
});

const headerStyles = css({
	display: "flex",
	justifyContent: "space-between",
	alignItems: "flex-start",
	marginBottom: "2rem",
	flexWrap: "wrap",
	gap: "1rem",
});

const titleGroupStyles = css({
	display: "flex",
	flexDirection: "column",
	gap: "0.5rem",
});

const titleStyles = css({
	fontSize: "1.5rem",
	fontWeight: 700,
	color: "white",
	display: "flex",
	alignItems: "center",
	gap: "0.75rem",
});

const slugStyles = css({
	fontSize: "0.875rem",
	color: "rgba(255, 255, 255, 0.5)",
});

const badgeStyles = css({
	display: "inline-block",
	padding: "0.25rem 0.5rem",
	fontSize: "0.625rem",
	fontWeight: 600,
	textTransform: "uppercase",
	borderRadius: "9999px",
});

const navStyles = css({
	display: "flex",
	gap: "0.5rem",
	marginBottom: "2rem",
	borderBottom: "1px solid rgba(255, 255, 255, 0.1)",
	paddingBottom: "0.5rem",
});

const navLinkStyles = css({
	padding: "0.5rem 1rem",
	color: "rgba(255, 255, 255, 0.6)",
	textDecoration: "none",
	fontSize: "0.875rem",
	fontWeight: 500,
	borderRadius: "0.375rem",
	transition: "all 0.2s",
	"&:hover": {
		color: "white",
		background: "rgba(255, 255, 255, 0.05)",
	},
});

const navLinkActiveStyles = css({
	color: "white",
	background: "rgba(139, 92, 246, 0.2)",
});

const gridStyles = css({
	display: "grid",
	gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))",
	gap: "1.5rem",
	marginBottom: "2rem",
});

const cardStyles = css({
	background: "rgba(255, 255, 255, 0.03)",
	border: "1px solid rgba(255, 255, 255, 0.1)",
	borderRadius: "1rem",
	padding: "1.5rem",
});

const cardTitleStyles = css({
	fontSize: "0.875rem",
	fontWeight: 600,
	color: "rgba(255, 255, 255, 0.5)",
	marginBottom: "0.5rem",
	textTransform: "uppercase",
});

const cardValueStyles = css({
	fontSize: "2rem",
	fontWeight: 700,
	color: "white",
});

const cardLinkStyles = css({
	display: "inline-flex",
	alignItems: "center",
	gap: "0.25rem",
	marginTop: "0.75rem",
	color: "#a78bfa",
	textDecoration: "none",
	fontSize: "0.875rem",
	"&:hover": {
		textDecoration: "underline",
	},
});

const sectionStyles = css({
	background: "rgba(255, 255, 255, 0.03)",
	border: "1px solid rgba(255, 255, 255, 0.1)",
	borderRadius: "1rem",
	padding: "2rem",
	marginBottom: "2rem",
});

const sectionTitleStyles = css({
	fontSize: "1.125rem",
	fontWeight: 600,
	color: "white",
	marginBottom: "1.5rem",
});

const actionsGridStyles = css({
	display: "grid",
	gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
	gap: "1rem",
});

const actionBtnStyles = css({
	display: "flex",
	flexDirection: "column",
	alignItems: "center",
	justifyContent: "center",
	gap: "0.75rem",
	padding: "1.5rem",
	background: "rgba(255, 255, 255, 0.03)",
	border: "1px solid rgba(255, 255, 255, 0.1)",
	borderRadius: "0.75rem",
	color: "white",
	textDecoration: "none",
	transition: "all 0.2s",
	cursor: "pointer",
	"&:hover": {
		background: "rgba(139, 92, 246, 0.1)",
		borderColor: "rgba(139, 92, 246, 0.3)",
	},
});

const actionIconStyles = css({
	width: "2.5rem",
	height: "2.5rem",
	display: "flex",
	alignItems: "center",
	justifyContent: "center",
	background: "rgba(139, 92, 246, 0.2)",
	borderRadius: "0.5rem",
	color: "#a78bfa",
});

const actionTextStyles = css({
	fontSize: "0.875rem",
	fontWeight: 500,
	textAlign: "center",
});

const dangerBtnStyles = css({
	display: "flex",
	flexDirection: "column",
	alignItems: "center",
	justifyContent: "center",
	gap: "0.75rem",
	padding: "1.5rem",
	background: "rgba(239, 68, 68, 0.05)",
	border: "1px solid rgba(239, 68, 68, 0.2)",
	borderRadius: "0.75rem",
	color: "#fca5a5",
	textDecoration: "none",
	transition: "all 0.2s",
	cursor: "pointer",
	"&:hover": {
		background: "rgba(239, 68, 68, 0.1)",
		borderColor: "rgba(239, 68, 68, 0.3)",
	},
});

const dangerIconStyles = css({
	width: "2.5rem",
	height: "2.5rem",
	display: "flex",
	alignItems: "center",
	justifyContent: "center",
	background: "rgba(239, 68, 68, 0.2)",
	borderRadius: "0.5rem",
	color: "#ef4444",
});

function getStatusColor(status: string) {
	switch (status) {
		case "draft": return "background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6);";
		case "registration": return "background: rgba(251, 191, 36, 0.2); color: #fde047;";
		case "active": return "background: rgba(34, 197, 94, 0.2); color: #86efac;";
		case "completed": return "background: rgba(99, 102, 241, 0.2); color: #a5b4fc;";
		default: return "";
	}
}

function getTypeColor(type: string) {
	return type === "solo"
		? "background: rgba(99, 102, 241, 0.2); color: #a5b4fc;"
		: "background: rgba(168, 85, 247, 0.2); color: #d8b4fe;";
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<title>{bracket.name} - Admin - Klustered '26</title>
	</head>
	<body>
		<main class={pageStyles}>
			<div class={containerStyles}>
				<a href="/admin" class={backLinkStyles}>
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
					</svg>
					Back to Admin
				</a>

				<header class={headerStyles}>
					<div class={titleGroupStyles}>
						<h1 class={titleStyles}>
							{bracket.name}
							<span class={badgeStyles} style={getTypeColor(bracket.type)}>
								{bracket.type}
							</span>
							<span class={badgeStyles} style={getStatusColor(bracket.status)}>
								{bracket.status}
							</span>
						</h1>
						<p class={slugStyles}>/bracket/{bracket.slug}</p>
					</div>
				</header>

				<nav class={navStyles}>
					<a href={`/admin/brackets/${id}`} class:list={[navLinkStyles, navLinkActiveStyles]}>
						Overview
					</a>
					<a href={`/admin/brackets/${id}/competitors`} class={navLinkStyles}>
						Competitors
					</a>
					<a href={`/admin/brackets/${id}/matches`} class={navLinkStyles}>
						Matches
					</a>
				</nav>

				<div class={gridStyles}>
					<div class={cardStyles}>
						<p class={cardTitleStyles}>Competitors</p>
						<p class={cardValueStyles}>{confirmedCount} / {totalCount}</p>
						<a href={`/admin/brackets/${id}/competitors`} class={cardLinkStyles}>
							Manage competitors &rarr;
						</a>
					</div>

					<div class={cardStyles}>
						<p class={cardTitleStyles}>Matches</p>
						<p class={cardValueStyles}>{matches.length}</p>
						<a href={`/admin/brackets/${id}/matches`} class={cardLinkStyles}>
							Manage matches &rarr;
						</a>
					</div>

					<div class={cardStyles}>
						<p class={cardTitleStyles}>Public View</p>
						<p class={cardValueStyles} style="font-size: 1rem;">/bracket/{bracket.slug}</p>
						<a href={`/bracket/${bracket.slug}`} class={cardLinkStyles} target="_blank">
							View bracket &rarr;
						</a>
					</div>
				</div>

				<section class={sectionStyles}>
					<h2 class={sectionTitleStyles}>Quick Actions</h2>
					<div class={actionsGridStyles}>
						{bracket.status === "draft" && (
							<button id="generate-btn" class={actionBtnStyles}>
								<div class={actionIconStyles}>
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
									</svg>
								</div>
								<span class={actionTextStyles}>Generate Bracket</span>
							</button>
						)}

						{(bracket.status === "draft" || bracket.status === "registration") && matches.length > 0 && (
							<button id="start-btn" class={actionBtnStyles}>
								<div class={actionIconStyles}>
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
										<path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
									</svg>
								</div>
								<span class={actionTextStyles}>Start Bracket</span>
							</button>
						)}

						<a href={`/admin/brackets/${id}/competitors`} class={actionBtnStyles}>
							<div class={actionIconStyles}>
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
								</svg>
							</div>
							<span class={actionTextStyles}>Import Registrations</span>
						</a>

						<button id="delete-btn" class={dangerBtnStyles}>
							<div class={dangerIconStyles}>
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
								</svg>
							</div>
							<span class={actionTextStyles}>Delete Bracket</span>
						</button>
					</div>
				</section>

				<section class={sectionStyles}>
					<h2 class={sectionTitleStyles}>Edit Bracket</h2>
					<BracketForm
						client:load
						mode="edit"
						bracket={bracket}
					/>
				</section>
			</div>
		</main>

		<script define:vars={{ bracketId: id }}>
			document.addEventListener("DOMContentLoaded", () => {
				const generateBtn = document.getElementById("generate-btn");
				const startBtn = document.getElementById("start-btn");
				const deleteBtn = document.getElementById("delete-btn");

				if (generateBtn) {
					generateBtn.addEventListener("click", async () => {
						if (!confirm("Generate the bracket structure? This will create all matches based on confirmed competitors.")) return;

						generateBtn.disabled = true;
						generateBtn.textContent = "Generating...";

						try {
							const response = await fetch("/_actions/bracket.generateMatches", {
								method: "POST",
								headers: { "Content-Type": "application/json" },
								body: JSON.stringify({ bracketId }),
							});

							if (response.ok) {
								window.location.reload();
							} else {
								alert("Failed to generate bracket");
							}
						} catch {
							alert("Failed to generate bracket");
						}
					});
				}

				if (startBtn) {
					startBtn.addEventListener("click", async () => {
						if (!confirm("Start the bracket? This will make it active and visible to the public.")) return;

						startBtn.disabled = true;
						startBtn.textContent = "Starting...";

						try {
							const response = await fetch("/_actions/bracket.startBracket", {
								method: "POST",
								headers: { "Content-Type": "application/json" },
								body: JSON.stringify({ bracketId }),
							});

							if (response.ok) {
								window.location.reload();
							} else {
								alert("Failed to start bracket");
							}
						} catch {
							alert("Failed to start bracket");
						}
					});
				}

				if (deleteBtn) {
					deleteBtn.addEventListener("click", async () => {
						if (!confirm("Are you sure you want to delete this bracket? This action cannot be undone.")) return;

						deleteBtn.disabled = true;
						deleteBtn.textContent = "Deleting...";

						try {
							const response = await fetch("/_actions/bracket.deleteBracket", {
								method: "POST",
								headers: { "Content-Type": "application/json" },
								body: JSON.stringify({ id: bracketId }),
							});

							if (response.ok) {
								window.location.href = "/admin";
							} else {
								alert("Failed to delete bracket");
							}
						} catch {
							alert("Failed to delete bracket");
						}
					});
				}
			});
		</script>
	</body>
</html>
