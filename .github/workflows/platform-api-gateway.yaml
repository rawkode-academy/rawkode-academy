name: rawkode.academy/api

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/platform-api-gateway.yaml"
      - "projects/rawkode.academy/api/**"
      - "projects/rawkode.academy/platform/*/read-model/schema.ts"
      - "projects/rawkode.academy/platform/*/read-model/publish.ts"
      - "projects/rawkode.academy/games/secrets-of-kubernetes/*/read-model/schema.ts"
      - "projects/rawkode.academy/games/secrets-of-kubernetes/*/read-model/publish.ts"
      - "projects/rawkode.academy/website/src/subgraph/**"
  pull_request:
    paths:
      - ".github/workflows/platform-api-gateway.yaml"
      - "projects/rawkode.academy/api/**"
      - "projects/rawkode.academy/platform/*/read-model/schema.ts"
      - "projects/rawkode.academy/platform/*/read-model/publish.ts"
      - "projects/rawkode.academy/games/secrets-of-kubernetes/*/read-model/schema.ts"
      - "projects/rawkode.academy/games/secrets-of-kubernetes/*/read-model/publish.ts"
      - "projects/rawkode.academy/website/src/subgraph/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Force Deploy: 1

jobs:
  collect-schemas:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install generator dependencies
        working-directory: projects/rawkode.academy/generators/projen-platform-service
        run: |
          bun install
          bun run types

      - name: Run projen for all platform services
        run: |
          for service in email-preferences email-service emoji-reactions video-likes; do
            SERVICE_DIR="projects/rawkode.academy/platform/$service"
            if [ -f "$SERVICE_DIR/.projenrc.ts" ]; then
              cd "$SERVICE_DIR"
              bun run .projenrc.ts
              cd -
            fi
          done

      - name: Run projen for all game services
        run: |
          for service in achievements leaderboard player-learned-phrases player-stats share-cards; do
            cd "projects/rawkode.academy/games/secrets-of-kubernetes/$service"
            bun run .projenrc.ts
            cd -
          done

      - name: Install all workspace dependencies
        run: bun install

      - name: Collect subgraph schemas
        run: |
          mkdir -p projects/rawkode.academy/api/schemas

          # User interaction services (still separate workers)
          for service in emoji-reactions video-likes email-preferences; do
            SERVICE_DIR="projects/rawkode.academy/platform/$service"

            if [ ! -d "$SERVICE_DIR/read-model" ]; then
              echo "Skipping $service: no read-model directory"
              continue
            fi

            echo "Processing $service..."

            # Run projen to ensure files are up to date
            bun run --cwd "$SERVICE_DIR" .projenrc.ts || true

            # Generate schema if publish.ts exists
            if [ -f "$SERVICE_DIR/read-model/publish.ts" ]; then
              bun run --cwd "$SERVICE_DIR" read-model/publish.ts || echo "Warning: Failed to generate schema for $service"
            fi

            # Copy schema if it exists
            if [ -f "$SERVICE_DIR/read-model/schema.gql" ]; then
              cp "$SERVICE_DIR/read-model/schema.gql" projects/rawkode.academy/api/schemas/$service.graphql
              echo "  Collected schema for $service"
            else
              echo "  Warning: No schema.gql for $service"
            fi
          done

          # Secret of Kubernetes Island game services
          for service in achievements leaderboard player-learned-phrases player-stats; do
            SERVICE_DIR="projects/rawkode.academy/games/secrets-of-kubernetes/$service"

            if [ ! -d "$SERVICE_DIR/read-model" ]; then
              echo "Skipping ski-$service: no read-model directory"
              continue
            fi

            echo "Processing ski-$service..."

            # Run projen to ensure files are up to date
            bun run --cwd "$SERVICE_DIR" .projenrc.ts || true

            # Generate schema if publish.ts exists
            if [ -f "$SERVICE_DIR/read-model/publish.ts" ]; then
              bun run --cwd "$SERVICE_DIR" read-model/publish.ts || echo "Warning: Failed to generate schema for ski-$service"
            fi

            # Copy schema if it exists (prefixed with ski-)
            if [ -f "$SERVICE_DIR/read-model/schema.gql" ]; then
              cp "$SERVICE_DIR/read-model/schema.gql" projects/rawkode.academy/api/schemas/ski-$service.graphql
              echo "  Collected schema for ski-$service"
            else
              echo "  Warning: No schema.gql for ski-$service"
            fi
          done

          # Website subgraph (serves all content: videos, shows, people, technologies, etc.)
          echo "Processing website subgraph..."
          bun run --cwd projects/rawkode.academy/website src/subgraph/publish.ts || echo "Warning: Failed to generate website schema"
          if [ -f "projects/rawkode.academy/website/src/subgraph/schema.gql" ]; then
            cp projects/rawkode.academy/website/src/subgraph/schema.gql projects/rawkode.academy/api/schemas/website.graphql
            echo "  Collected schema for website"
          else
            echo "  Warning: No schema.gql for website"
          fi

          echo ""
          echo "Collected schemas:"
          ls -la projects/rawkode.academy/api/schemas/ || echo "No schemas collected"

      - name: Upload schemas
        uses: actions/upload-artifact@v4
        with:
          name: schemas
          path: projects/rawkode.academy/api/schemas/
          retention-days: 1

  compose-and-deploy:
    needs: collect-schemas
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download schemas
        uses: actions/download-artifact@v4
        with:
          name: schemas
          path: projects/rawkode.academy/api/schemas/

      - name: List collected schemas
        run: |
          echo "Schemas to compose:"
          ls -la projects/rawkode.academy/api/schemas/

      - name: Install workspace dependencies
        run: bun install

      - name: Compose supergraph
        working-directory: projects/rawkode.academy/api
        run: bun run compose

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: "rawkode-academy-production"
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Get secrets from GCP Secret Manager
        id: secrets
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |
            CLOUDFLARE_WORKERS_TOKEN:projects/458678766461/secrets/cloudflare-workers-token

      - name: Deploy Gateway
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: projects/rawkode.academy/api
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.secrets.outputs.CLOUDFLARE_WORKERS_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "0aeb879de8e3cdde5fb3d413025222ce"
        run: npx wrangler deploy

      - name: Deploy Preview
        if: github.event_name == 'pull_request'
        working-directory: projects/rawkode.academy/api
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.secrets.outputs.CLOUDFLARE_WORKERS_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "0aeb879de8e3cdde5fb3d413025222ce"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx wrangler versions upload --preview-alias pr-${{ github.event.pull_request.number }}
          PREVIEW_URL="https://pr-${{ github.event.pull_request.number }}-platform-api-gateway.rawkodeacademy.workers.dev"
          gh pr comment ${{ github.event.pull_request.number }} --body "API Gateway Preview: $PREVIEW_URL"
